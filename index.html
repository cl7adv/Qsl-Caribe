const canvas = document.getElementById('qC'), ctx = canvas.getContext('2d');
        let bgImg = new Image(), l1Img = new Image(), l2Img = new Image();
        let pos = { 
            l1:{x:730, y:50, w:120, h:120}, 
            l2:{x:600, y:50, w:100, h:100}, 
            call:{x:50, y:120, w:350}, 
            box:{x:50, y:320, w:800, h:180} 
        };
        let drag = null, offset = {x:0, y:0};

        // Generador de fondos internos (Sin internet)
        function setBG(type) {
            const tC = document.createElement('canvas');
            tC.width = 900; tC.height = 550;
            const tCtx = tC.getContext('2d');
            if(type===0) { 
                let g=tCtx.createLinearGradient(0,0,0,550); g.addColorStop(0,'#001a33'); g.addColorStop(1,'#000'); 
                tCtx.fillStyle=g; tCtx.fillRect(0,0,900,550);
                tCtx.fillStyle="#ffffff11"; for(let i=0;i<50;i++) tCtx.fillRect(Math.random()*900, Math.random()*550, 2, 2);
            }
            else if(type===1) { tCtx.fillStyle='#1a001a'; tCtx.fillRect(0,0,900,550); }
            else if(type===2) { 
                tCtx.fillStyle='#050505'; tCtx.fillRect(0,0,900,550); 
                tCtx.strokeStyle='#0ff1'; for(let i=0;i<900;i+=30) tCtx.strokeRect(i,0,1,550);
            }
            else { 
                tCtx.fillStyle='#0a0a0a'; tCtx.fillRect(0,0,900,550); 
                tCtx.strokeStyle='#f0f1'; for(let i=0;i<12;i++){tCtx.beginPath();tCtx.arc(450,275,i*40,0,7);tCtx.stroke();}
            }
            bgImg.src = tC.toDataURL();
        }
        setBG(0);

        function setup(id, img) { 
            document.getElementById(id).onchange = e => { 
                const r=new FileReader(); 
                r.onload=v=>{img.src=v.target.result;}; 
                if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); 
            }; 
        }
        setup('bgI', bgImg); setup('l1I', l1Img); setup('l2I', l2Img);
        bgImg.onload = l1Img.onload = l2Img.onload = draw;

        // Movimiento
        canvas.onmousedown = canvas.ontouchstart = e => {
            const r = canvas.getBoundingClientRect(), sX = 900/r.width, sY = 550/r.height;
            const m = {x:((e.clientX||e.touches[0].clientX)-r.left)*sX, y:((e.clientY||e.touches[0].clientY)-r.top)*sY};
            if(l1Img.src && m.x>pos.l1.x && m.x<pos.l1.x+pos.l1.w && m.y>pos.l1.y && m.y<pos.l1.y+pos.l1.h) drag='l1';
            else if(l2Img.src && m.x>pos.l2.x && m.x<pos.l2.x+pos.l2.w && m.y>pos.l2.y && m.y<pos.l2.y+pos.l2.h) drag='l2';
            else if(m.x>pos.call.x && m.x<pos.call.x+pos.call.w && m.y>pos.call.y-80 && m.y<pos.call.y) drag='call';
            else if(m.x>pos.box.x && m.x<pos.box.x+pos.box.w && m.y>pos.box.y && m.y<pos.box.y+pos.box.h) drag='box';
            if(drag) { offset.x=m.x-pos[drag].x; offset.y=m.y-pos[drag].y; }
        };
        window.onmousemove = window.ontouchmove = e => {
            if(!drag) return;
            const r = canvas.getBoundingClientRect(), sX = 900/r.width, sY = 550/r.height;
            const m = {x:((e.clientX||e.touches[0].clientX)-r.left)*sX, y:((e.clientY||e.touches[0].clientY)-r.top)*sY};
            pos[drag].x=m.x-offset.x; pos[drag].y=m.y-offset.y; draw();
        };
        window.onmouseup = window.ontouchend = () => drag=null;

        function drawF(l, v, x, y, w, c) {
            ctx.shadowBlur=0; ctx.fillStyle=c; ctx.font="bold 14px sans-serif"; ctx.fillText(l+":", x, y);
            ctx.shadowBlur=8; ctx.shadowColor=c; ctx.font="bold 18px monospace"; ctx.fillText(v||"", x+90, y);
            ctx.strokeStyle=c; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x+85,y+5); ctx.lineTo(x+w,y+5); ctx.stroke();
        }

        function draw() {
            ctx.clearRect(0,0,900,550);
            if(bgImg.src) ctx.drawImage(bgImg,0,0,900,550);
            
            // Marca de agua
            ctx.font="bold 20px Arial"; ctx.fillStyle="#ff0044"; ctx.shadowBlur=10; ctx.shadowColor="red";
            ctx.fillText("ZMR-CUBA", 770, 30); ctx.shadowBlur=0;

            pos.l1.w = pos.l1.h = parseInt(document.getElementById('l1S').value);
            pos.l2.w = pos.l2.h = parseInt(document.getElementById('l2S').value);
            if(l1Img.src && l1Img.complete) ctx.drawImage(l1Img, pos.l1.x, pos.l1.y, pos.l1.w, pos.l1.h);
            if(l2Img.src && l2Img.complete) ctx.drawImage(l2Img, pos.l2.x, pos.l2.y, pos.l2.w, pos.l2.h);
            
            const cC = document.getElementById('cCol').value;
            ctx.shadowBlur=20; ctx.shadowColor=cC; ctx.fillStyle=cC; ctx.font="bold 85px sans-serif";
            ctx.fillText(document.getElementById('myC').value.toUpperCase(), pos.call.x, pos.call.y);
            ctx.shadowBlur=5; ctx.fillStyle="#fff"; ctx.font="25px monospace";
            ctx.fillText("LOC: "+document.getElementById('myL').value, pos.call.x, pos.call.y+40);
            
            const tC = document.getElementById('tCol').value;
            ctx.shadowBlur=0; ctx.fillStyle="rgba(0,0,0,0.8)"; ctx.fillRect(pos.box.x, pos.box.y, pos.box.w, pos.box.h);
            ctx.strokeStyle=tC; ctx.lineWidth=2; ctx.strokeRect(pos.box.x, pos.box.y, pos.box.w, pos.box.h);
            
            drawF("TO RADIO", document.getElementById('toC').value, pos.box.x+20, pos.box.y+45, pos.box.w-40, tC);
            drawF("DATA", document.getElementById('qD').value+" "+document.getElementById('qT').value, pos.box.x+20, pos.box.y+95, 300, tC);
            drawF("BAND", document.getElementById('qB').value, pos.box.x+340, pos.box.y+95, 120, tC);
            drawF("MODE", document.getElementById('qM').value, pos.box.x+480, pos.box.y+95, 120, tC);
            drawF("RST", document.getElementById('qR').value, pos.box.x+620, pos.box.y+95, 120, tC);
            drawF("MSG", document.getElementById('qG').value, pos.box.x+20, pos.box.y+145, pos.box.w-40, tC);
        }
        function download() { 
            const a=document.createElement('a'); 
            a.download="QSL_"+document.getElementById('myC').value+".png"; 
            a.href=canvas.toDataURL("image/png", 1.0); 
            a.click(); 
        }
    </script>
</body>
</html>
