<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSL ELITE v28.0 - RADIO CLUB SANTA CRUZ DEL SUR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root {
            --bg-deep: #020408;
            --panel-bg: #0d1117;
            --neon-cyan: #00f2ff;
            --neon-pink: #ff007b;
            --text-main: #e6edf3;
            --border-color: #30363d;
            --header-bg: #161b22;
        }

        /* AVISO HORIZONTAL PARA M√ìVILES */
        #orientation-warning {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; color: var(--neon-cyan);
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; font-weight: bold;
        }

        @media screen and (max-width: 900px) and (orientation: portrait) {
            #orientation-warning { display: flex; }
        }

        /* ANIMACI√ìN DE INICIO PERSONALIZADA CL7ADV */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #0d1117 0%, #000 100%);
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 1.5s ease-in-out;
        }

        .club-name {
            font-size: 1.5rem; color: white; text-transform: uppercase;
            letter-spacing: 3px; margin-bottom: 5px; text-align: center;
        }

        .callsign-anim {
            font-size: 4rem; font-weight: 900; color: var(--neon-cyan);
            text-shadow: 0 0 20px var(--neon-cyan);
            animation: neonPulse 2s infinite alternate;
        }

        @keyframes neonPulse {
            from { opacity: 0.4; transform: scale(0.98); text-shadow: 0 0 10px var(--neon-cyan); }
            to { opacity: 1; transform: scale(1); text-shadow: 0 0 40px var(--neon-cyan), 0 0 60px var(--neon-pink); }
        }

        /* ESTRUCTURA GENERAL */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-deep); color: var(--text-main);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        header {
            background: var(--header-bg); border-bottom: 2px solid var(--neon-cyan);
            padding: 8px 15px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .app-container { display: flex; flex: 1; overflow: hidden; }

        @media (max-width: 900px) {
            .app-container { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100% !important; border-right: none !important; height: auto !important; }
            body { overflow-y: auto; height: auto; }
        }

        .sidebar {
            width: 420px; background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px; overflow-y: scroll; box-sizing: border-box;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 15px; padding: 15px; margin-bottom: 20px;
        }

        .section-header {
            font-size: 0.8rem; font-weight: 900; color: var(--neon-pink);
            text-transform: uppercase; margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
        }

        input[type="text"], input[type="file"], select {
            width: 100%; background: #010409; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px; color: white; margin-bottom: 10px;
        }

        .btn {
            width: 100%; padding: 14px; border-radius: 10px; border: none;
            font-weight: 800; cursor: pointer; text-transform: uppercase;
            transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .btn-primary { background: var(--neon-cyan); color: #000; }
        .btn-secondary { background: var(--neon-pink); color: #fff; }
        .btn-dark { background: #21262d; color: #fff; border: 1px solid var(--border-color); }

        .preview-area {
            flex: 1; background: #000; display: flex; justify-content: center;
            align-items: center; position: relative; padding: 20px;
        }

        canvas {
            max-width: 100%; max-height: 100%;
            box-shadow: 0 0 60px rgba(0,0,0,1);
        }

        #qso-indicator {
            position: absolute; bottom: 15px; left: 15px;
            background: rgba(0, 242, 255, 0.1); border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan); padding: 8px 15px; font-size: 0.7rem;
            border-radius: 8px; font-family: monospace; backdrop-filter: blur(5px);
        }
    </style>
</head>
<body onload="initHyperStudio()">

<div id="orientation-warning">
    <div style="font-size: 50px;">üîÑ</div>
    <p>USA ESTA APP DE FORMA HORIZONTAL</p>
    <p style="font-size: 12px; opacity: 0.6;">Para una mejor experiencia en la edici√≥n de tu QSL</p>
</div>

<div id="intro-overlay">
    <div class="club-name">Radio Club Santa Cruz del Sur</div>
    <div class="callsign-anim">CL7ADV</div>
    <p id="boot-text" style="color: white; margin-top:20px; font-family: monospace; opacity: 0.5;">CARGANDO SISTEMA...</p>
</div>

<header>
    <div>
        <span style="color:var(--neon-cyan); font-weight: 900;">QSL ELITE</span>
        <span style="color:var(--neon-pink); margin-left: 5px;">SANTA CRUZ DEL SUR</span>
    </div>
    <div id="digital-clock" style="font-family: monospace; color: var(--neon-cyan);">00:00:00</div>
</header>

<div class="app-container">
    <div class="sidebar">
        <div class="control-section">
            <div class="section-header"><span>üñºÔ∏è</span> Fondo</div>
            <input type="file" id="bgLoader" accept="image/*">
            <button class="btn btn-dark" onclick="resetBackground()">RESETEAR</button>
        </div>

        <div class="control-section">
            <div class="section-header"><span>üë§</span> Mi Estaci√≥n</div>
            <input type="text" id="myCall" placeholder="MI INDICATIVO" oninput="processMyIdentity(this.value)">
            <input type="text" id="myCountry" placeholder="PA√çS" oninput="manualRender()">
        </div>

        <div class="control-section">
            <div class="section-header"><span>üìú</span> Logs ADIF</div>
            <input type="file" id="adifLoader" accept=".adi,.adif">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-dark" onclick="navQSO(-1)">ANT.</button>
                <button class="btn btn-dark" onclick="navQSO(1)">SIG.</button>
            </div>
        </div>

        <div class="control-section">
            <div class="section-header"><span>üé®</span> Colores</div>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
                <input type="color" id="cCall" value="#ff007b" oninput="manualRender()">
                <input type="color" id="cCountry" value="#00f2ff" oninput="manualRender()">
                <input type="color" id="cBox" value="#0d1117" oninput="manualRender()">
                <input type="color" id="cBorder" value="#00f2ff" oninput="manualRender()">
                <input type="color" id="cText" value="#ffffff" oninput="manualRender()">
                <input type="color" id="cLabel" value="#00f2ff" oninput="manualRender()">
            </div>
        </div>

        <div class="control-section">
            <div class="section-header"><span>üìù</span> Datos QSO</div>
            <input type="text" id="toCall" placeholder="CORRESPONSAL" oninput="manualRender()">
            <input type="text" id="qDate" placeholder="FECHA" oninput="manualRender()">
            <input type="text" id="qTime" placeholder="HORA UTC" oninput="manualRender()">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                <input type="text" id="qBand" placeholder="BAND" oninput="manualRender()">
                <input type="text" id="qMode" placeholder="MODE" oninput="manualRender()">
                <input type="text" id="qRst" placeholder="RST" oninput="manualRender()">
            </div>
        </div>

        <div class="control-section">
            <button class="btn btn-primary" onclick="saveCurrentQSL()">GUARDAR QSL</button>
            <button class="btn btn-secondary" id="bulkBtn" style="display:none;" onclick="exportAllInZip()">EXPORTAR LOG ZIP</button>
        </div>
    </div>

    <div class="preview-area">
        <div id="qso-indicator">SIN DATOS</div>
        <canvas id="mainCanvas" width="1800" height="1100"></canvas>
    </div>
</div>

<script>
const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d');
let currentBackground = new Image(), qsoDataArray = [], currentIdx = 0;

function initHyperStudio() {
    setTimeout(() => {
        document.getElementById('intro-overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('intro-overlay').style.display = 'none', 1500);
    }, 3000);
    setInterval(() => {
        document.getElementById('digital-clock').innerText = new Date().toISOString().substr(11, 8);
    }, 1000);
    renderGraphics();
}

function processMyIdentity(val) {
    const cleanCall = val.trim().toUpperCase();
    document.getElementById('myCall').value = cleanCall;
    const db = {'EA': 'ESPA√ëA', 'CL': 'CUBA', 'CO': 'CUBA', 'XE': 'M√âXICO', 'LU': 'ARGENTINA', 'KP4': 'PUERTO RICO'};
    document.getElementById('myCountry').value = db[cleanCall.substring(0,3)] || db[cleanCall.substring(0,2)] || "DESCONOCIDO";
    renderGraphics();
}

document.getElementById('bgLoader').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => { currentBackground.src = ev.target.result; currentBackground.onload = renderGraphics; };
    reader.readAsDataURL(e.target.files[0]);
};

function resetBackground() { currentBackground = new Image(); renderGraphics(); }

document.getElementById('adifLoader').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => parseADIF(ev.target.result);
    reader.readAsText(e.target.files[0]);
};

function parseADIF(text) {
    qsoDataArray = text.split(/<eor>/i).map(chunk => {
        if(chunk.length < 10) return null;
        const get = (tag) => {
            const m = chunk.match(new RegExp(`<${tag}:\\d+>([^<]*)`, "i"));
            return m ? m[1].trim() : "";
        };
        return { call: get('CALL'), date: get('QSO_DATE'), time: get('TIME_ON'), band: get('BAND'), mode: get('MODE'), rst: get('RST_SENT') };
    }).filter(q => q && q.call);
    if(qsoDataArray.length) { currentIdx = 0; document.getElementById('bulkBtn').style.display = 'flex'; sync(); }
}

function navQSO(d) { if(qsoDataArray.length) { currentIdx = (currentIdx + d + qsoDataArray.length) % qsoDataArray.length; sync(); } }

function sync() {
    const q = qsoDataArray[currentIdx];
    document.getElementById('toCall').value = q.call;
    document.getElementById('qBand').value = q.band;
    document.getElementById('qMode').value = q.mode;
    document.getElementById('qRst').value = q.rst;
    document.getElementById('qDate').value = q.date.replace(/(\d{4})(\d{2})(\d{2})/, '$3/$2/$1');
    document.getElementById('qTime').value = q.time.substring(0,2)+":"+q.time.substring(2,4);
    document.getElementById('qso-indicator').innerText = `REGISTRO: ${currentIdx + 1} / ${qsoDataArray.length}`;
    renderGraphics();
}

function manualRender() { renderGraphics(); }

function renderGraphics() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,1800,1100);
    if(currentBackground.src) ctx.drawImage(currentBackground, 0, 0, 1800, 1100);
    ctx.save();
    ctx.shadowBlur = 20; ctx.shadowColor = "black";
    ctx.fillStyle = document.getElementById('cCall').value;
    ctx.font = "900 230px sans-serif";
    ctx.fillText(document.getElementById('myCall').value || "CL7ADV", 80, 260);
    ctx.fillStyle = document.getElementById('cCountry').value;
    ctx.font = "bold 90px sans-serif";
    ctx.fillText(document.getElementById('myCountry').value || "CUBA", 90, 370);
    ctx.restore();
    ctx.fillStyle = document.getElementById('cBox').value;
    ctx.globalAlpha = 0.9;
    ctx.beginPath(); ctx.roundRect(80, 800, 1640, 210, 25); ctx.fill();
    ctx.globalAlpha = 1.0;
    ctx.strokeStyle = document.getElementById('cBorder').value;
    ctx.lineWidth = 6; ctx.stroke();
    const vals = [document.getElementById('toCall').value, document.getElementById('qDate').value, document.getElementById('qTime').value, document.getElementById('qBand').value, document.getElementById('qMode').value, document.getElementById('qRst').value];
    const labs = ["CORRESPONSAL", "FECHA (UTC)", "HORA", "BANDA", "MODO", "RST"];
    labs.forEach((l, i) => {
        let x = 130 + (i * 255);
        ctx.fillStyle = document.getElementById('cLabel').value; ctx.font = "800 22px sans-serif"; ctx.fillText(l, x, 860);
        ctx.fillStyle = document.getElementById('cText').value; ctx.font = "bold 52px monospace"; ctx.fillText(vals[i] || "---", x, 940);
    });
}

function saveCurrentQSL() {
    const link = document.createElement('a');
    link.download = `QSL_${document.getElementById('toCall').value}.jpg`;
    link.href = canvas.toDataURL('image/jpeg', 0.9);
    link.click();
}

async function exportAllInZip() {
    const zip = new JSZip();
    for(let i=0; i<qsoDataArray.length; i++) {
        currentIdx = i; sync();
        const data = canvas.toDataURL('image/jpeg', 0.7).split('base64,')[1];
        zip.file(`${qsoDataArray[i].call}.jpg`, data, {base64: true});
    }
    saveAs(await zip.generateAsync({type:"blob"}), "LOG_CL7ADV.zip");
}
</script>
</body>
</html>
