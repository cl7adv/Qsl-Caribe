<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSL ELITE PRO v18.0 - MASTER PAN-HISP√ÅNICA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root { --bg: #050a14; --panel: #0e2431; --neon: #00ff99; --pink: #ff00ff; --text: #e6faff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        header { padding: 15px; text-align: center; width: 100%; background: #0a1921; border-bottom: 4px solid var(--neon); box-shadow: 0 4px 20px rgba(0,255,153,0.3); }
        .main-layout { display: flex; width: 100%; max-width: 1750px; padding: 20px; gap: 20px; }
        .sidebar { flex: 0 0 380px; background: var(--panel); padding: 20px; border-radius: 15px; border: 1px solid #1a3a4a; height: 88vh; overflow-y: auto; }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--neon); border-radius: 10px; }
        .section-title { color: var(--neon); font-size: 0.75em; margin: 15px 0 8px; display: block; text-transform: uppercase; font-weight: 800; border-bottom: 1px solid #333; }
        .ctrl-group { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #1a3a4a; }
        label { font-size: 0.65em; color: #88a0b0; display: block; margin-bottom: 4px; text-transform: uppercase; }
        input[type="text"], input[type="file"] { width: 100%; padding: 10px; background: #050a14; border: 1px solid #1a3a4a; border-radius: 6px; color: white; margin-bottom: 8px; box-sizing: border-box; }
        input[type="range"] { width: 100%; margin: 8px 0; cursor: pointer; }
        .btn { width: 100%; padding: 15px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; margin: 5px 0; transition: 0.3s; }
        .btn-zip { background: var(--pink); color: white; display: none; }
        .btn-hd { background: var(--neon); color: #000; }
        canvas { width: 100%; max-width: 1100px; height: auto; border: 3px solid var(--neon); border-radius: 12px; background: #000; cursor: crosshair; }
    </style>
</head>
<body>

<header><h1>QSL ELITE PRO <span style="color:var(--pink)">v18.0 MASTER</span></h1></header>

<div class="main-layout">
    <div class="sidebar">
        <span class="section-title">üñºÔ∏è PERSONALIZACI√ìN FONDO</span>
        <div class="ctrl-group">
            <label>Subir Fotograf√≠a de Fondo</label>
            <input type="file" accept="image/*" onchange="loadBG(event)">
        </div>

        <span class="section-title">üñºÔ∏è LOGOS MOVIBLES</span>
        <div id="logoControls">
            <script>
                for(let i=0; i<4; i++) {
                    document.write(`<div class="ctrl-group">
                        <label>Logo ${i+1}</label>
                        <input type="file" accept="image/*" onchange="loadL(${i}, event)">
                        <label>Escala</label><input type="range" id="sz${i}" min="40" max="600" value="160" oninput="draw()">
                    </div>`);
                }
            </script>
        </div>

        <span class="section-title">üìÇ GESTI√ìN DE LOGS ADIF</span>
        <div class="ctrl-group">
            <input type="file" accept=".adi,.adif" onchange="handleA(event)">
            <button class="btn btn-zip" id="bz" onclick="zipIt()">GENERAR PACK .ZIP</button>
        </div>

        <span class="section-title">üë§ ESTACI√ìN DEL OPERADOR</span>
        <div class="ctrl-group">
            <label>Indicativo (Callsign)</label><input type="text" id="mC" placeholder="EA1ABC" oninput="dxDetect()">
            <label>Entidad / Pa√≠s</label><input type="text" id="mP" placeholder="PA√çS" oninput="draw()">
        </div>

        <span class="section-title">üìê PAR√ÅMETROS DEL CUADRO</span>
        <div class="ctrl-group">
            <label>Ancho</label><input type="range" id="bW" min="800" max="1750" value="1620" oninput="draw()">
            <label>Alto</label><input type="range" id="bH" min="100" max="500" value="180" oninput="draw()">
            <label>Opacidad</label><input type="range" id="bO" min="0" max="100" value="85" oninput="draw()">
            <label>Grosor Borde</label><input type="range" id="bS" min="1" max="15" value="4" oninput="draw()">
        </div>

        <span class="section-title">üì° DATOS MANUALES QSO</span>
        <div class="ctrl-group">
            <input type="text" id="tC" placeholder="TO CALL" oninput="draw()">
            <div style="display:flex; gap:5px;"><input type="text" id="qD" placeholder="FECHA"><input type="text" id="qT" placeholder="HORA"></div>
            <div style="display:flex; gap:5px;"><input type="text" id="qB" placeholder="BANDA"><input type="text" id="qM" placeholder="MODO"><input type="text" id="qR" placeholder="RST"></div>
        </div>
        <button class="btn btn-hd" onclick="save()">GUARDAR QSL HD (SINGLE)</button>
    </div>

    <div class="canvas-area">
        <canvas id="cv" width="1800" height="1100"></canvas>
    </div>
</div>

<script>
    const cv = document.getElementById('cv'), ctx = cv.getContext('2d');
    let bg = new Image(); bg.crossOrigin = "anonymous";
    let logos = Array.from({length:4},()=>({img:new Image(),x:1400,y:100,ok:false}));
    let pC = {x:120,y:250}, pT = {x:100,y:820}, drag=null, off={x:0,y:0}, actL=-1;
    let records = [];

    // DATABASE COMPLETA: HISPANOAM√âRICA, ESPA√ëA Y USA
    const DXCC = {
        // CHILE (EXTENDIDO)
        "CA":"CHILE","CB":"CHILE","CC":"CHILE","CD":"CHILE","CE":"CHILE","XQ":"CHILE","XR":"CHILE","3G":"CHILE",
        // ARGENTINA (EXTENDIDO)
        "LU":"ARGENTINA","LW":"ARGENTINA","AY":"ARGENTINA","AZ":"ARGENTINA","LO":"ARGENTINA","LT":"ARGENTINA","L1":"ARGENTINA","L2":"ARGENTINA","L3":"ARGENTINA","L4":"ARGENTINA","L5":"ARGENTINA","L6":"ARGENTINA","L7":"ARGENTINA","L8":"ARGENTINA","L9":"ARGENTINA",
        // ESPA√ëA (EXTENDIDO)
        "EA":"SPAIN","EB":"SPAIN","EC":"SPAIN","ED":"SPAIN","EE":"SPAIN","EF":"SPAIN","EG":"SPAIN","EH":"SPAIN","AM":"SPAIN","AN":"SPAIN","AO":"SPAIN",
        // USA (EXTENDIDO)
        "W":"USA","K":"USA","N":"USA","AA":"USA","AB":"USA","AC":"USA","AD":"USA","AE":"USA","AF":"USA","AG":"USA","AH":"USA","AI":"USA","AJ":"USA","AK":"USA","AL":"USA","AM":"USA","K1":"USA","K2":"USA","K3":"USA","K4":"USA","K5":"USA","K6":"USA","K7":"USA","K8":"USA","K9":"USA","K0":"USA",
        // M√âXICO
        "XE":"MEXICO","XF":"MEXICO","XG":"MEXICO","4A":"MEXICO","4B":"MEXICO","4C":"MEXICO",
        // COLOMBIA
        "HK":"COLOMBIA","HJ":"COLOMBIA","5K":"COLOMBIA","5L":"COLOMBIA",
        // VENEZUELA
        "YV":"VENEZUELA","YW":"VENEZUELA","YX":"VENEZUELA","4M":"VENEZUELA",
        // PER√ö
        "OA":"PERU","OB":"PERU","OC":"PERU","4T":"PERU",
        // URUGUAY
        "CX":"URUGUAY","CV":"URUGUAY","CW":"URUGUAY",
        // PARAGUAY
        "ZP":"PARAGUAY",
        // BOLIVIA
        "CP":"BOLIVIA",
        // ECUADOR
        "HC":"ECUADOR","HD":"ECUADOR",
        // CENTROAM√âRICA
        "TI":"COSTA RICA","TE":"COSTA RICA","TG":"GUATEMALA","TD":"GUATEMALA","HR":"HONDURAS","HQ":"HONDURAS","YS":"EL SALVADOR","YN":"NICARAGUA","HT":"NICARAGUA","HP":"PANAMA","HO":"PANAMA","V3":"BELIZE",
        // CARIBE HISPANO
        "CO":"CUBA","CM":"CUBA","CL":"CUBA","T4":"CUBA","HI":"DOMINICAN REP.","KP":"PUERTO RICO","WP":"PUERTO RICO","NP":"PUERTO RICO",
        // GUINEA ECUATORIAL (HABLA HISPANA AF)
        "3C":"EQUAT. GUINEA"
    };

    function dxDetect() {
        const c = document.getElementById('mC').value.toUpperCase();
        let f = "RADIO STATION";
        for(let i=3; i>=1; i--) { let p=c.substring(0,i); if(DXCC[p]) { f=DXCC[p]; break; } }
        document.getElementById('mP').value = f; draw();
    }

    function loadBG(e) { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(ev)=>{ bg.src=ev.target.result; bg.onload=draw; }; r.readAsDataURL(f); } }
    function loadL(i,e) { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(ev)=>{ logos[i].img.onload=()=>{ logos[i].ok=true; draw(); }; logos[i].img.src=ev.target.result; }; r.readAsDataURL(f); } }

    function handleA(e) {
        const f=e.target.files[0]; if(!f) return;
        const r=new FileReader();
        r.onload=(ev)=>{
            records=parse(ev.target.result);
            const op=ev.target.result.match(/<(?:STATION_CALLSIGN|OPERATOR):\d+>([^<]*)/i);
            if(op){ document.getElementById('mC').value=op[1].trim().toUpperCase(); dxDetect(); }
            if(records.length>0){ document.getElementById('bz').style.display='block'; fill(records[0]); }
        };
        r.readAsText(f);
    }

    function parse(t) {
        return t.split(/<eor>/i).filter(e=>e.length>10).map(e=>{
            const r={}; const tags={CALL:'t',QSO_DATE:'d',TIME_ON:'h',BAND:'b',MODE:'m',RST_SENT:'r'};
            for(let k in tags){ const m=e.match(new RegExp(`<${k}:\\d+>([^<]*)`,"i")); if(m) r[tags[k]]=m[1].trim(); }
            return r;
        }).filter(i=>i.t);
    }

    function fill(r) {
        document.getElementById('tC').value=r.t; document.getElementById('qB').value=r.b;
        document.getElementById('qM').value=(r.m&&r.m.includes('FT'))?'DV':r.m;
        document.getElementById('qR').value=r.r;
        if(r.d) document.getElementById('qD').value=`${r.d.substr(6,2)}/${r.d.substr(4,2)}/${r.d.substr(0,4)}`;
        if(r.h) document.getElementById('qT').value=`${r.h.substr(0,2)}:${r.h.substr(2,2)}`;
        draw();
    }

    async function zipIt() {
        const z=new JSZip();
        for(let i=0;i<records.length;i++){
            fill(records[i]); await new Promise(res=>setTimeout(res,50));
            const b=await new Promise(res=>cv.toBlob(res,'image/png',0.9));
            z.file(`QSL_${records[i].t}.png`, b);
        }
        z.generateAsync({type:"blob"}).then(c=>saveAs(c,"PACK_QSL_PRO.zip"));
    }

    function draw() {
        ctx.clearRect(0,0,1800,1100);
        if(bg.src) ctx.drawImage(bg,0,0,1800,1100);
        logos.forEach((l,i)=>{ if(l.ok) ctx.drawImage(l.img, l.x, l.y, document.getElementById(`sz${i}`).value, document.getElementById(`sz${i}`).value); });
        
        ctx.save(); ctx.shadowBlur=20; ctx.shadowColor="black";
        ctx.fillStyle="#ff00ff"; ctx.font="bold 200px sans-serif";
        ctx.fillText(document.getElementById('mC').value.toUpperCase()||"CALLSIGN", pC.x, pC.y);
        ctx.fillStyle="#00ff99"; ctx.font="bold 85px sans-serif";
        ctx.fillText(document.getElementById('mP').value.toUpperCase()||"COUNTRY", pC.x+10, pC.y+110);
        ctx.restore();

        const w=parseInt(document.getElementById('bW').value), h=parseInt(document.getElementById('bH').value);
        const o=parseInt(document.getElementById('bO').value)/100, s=parseInt(document.getElementById('bS').value);
        
        ctx.fillStyle=`rgba(10,25,33,${o})`; ctx.fillRect(pT.x, pT.y, w, h);
        ctx.strokeStyle="#00ff99"; ctx.lineWidth=s; ctx.strokeRect(pT.x, pT.y, w, h);
        ctx.beginPath(); ctx.moveTo(pT.x, pT.y+60); ctx.lineTo(pT.x+w, pT.y+60); ctx.stroke();

        const labs=["QSO WITH","DATE","TIME (UTC)","BAND","MODE","RST"];
        const vals=[document.getElementById('tC').value, document.getElementById('qD').value, document.getElementById('qT').value, document.getElementById('qB').value, document.getElementById('qM').value, document.getElementById('qR').value];
        const step=w/6;
        labs.forEach((l,i)=>{
            ctx.fillStyle="#00ff99"; ctx.font="bold 24px Arial"; ctx.fillText(l, pT.x+30+(i*step), pT.y+42);
            ctx.fillStyle="white"; ctx.font="bold 48px Courier New"; ctx.fillText(vals[i]||"---", pT.x+30+(i*step), pT.y+130);
        });
    }

    cv.onmousedown=(e)=>{
        const r=cv.getBoundingClientRect(); const mx=(e.clientX-r.left)*(1800/r.width), my=(e.clientY-r.top)*(1100/r.height);
        for(let i=0;i<4;i++){ if(logos[i].ok){ let s=parseInt(document.getElementById(`sz${i}`).value); if(mx>logos[i].x && mx<logos[i].x+s && my>logos[i].y && my<logos[i].y+s){ drag='l'; actL=i; off={x:mx-logos[i].x, y:my-logos[i].y}; return; } } }
        if(mx>pT.x && mx<pT.x+parseInt(document.getElementById('bW').value) && my>pT.y && my<pT.y+parseInt(document.getElementById('bH').value)){ drag='t'; off={x:mx-pT.x, y:my-pT.y}; }
        else if(mx>pC.x && mx<pC.x+800 && my>pC.y-150 && my<pC.y+50){ drag='c'; off={x:mx-pC.x, y:my-pC.y}; }
    };
    window.onmousemove=(e)=>{
        if(!drag) return; const r=cv.getBoundingClientRect(); const mx=(e.clientX-r.left)*(1800/r.width), my=(e.clientY-r.top)*(1100/r.height);
        if(drag==='l'){ logos[actL].x=mx-off.x; logos[actL].y=my-off.y; }
        if(drag==='t'){ pT.x=mx-off.x; pT.y=my-off.y; }
        if(drag==='c'){ pC.x=mx-off.x; pC.y=my-off.y; }
        draw();
    };
    window.onmouseup=()=>drag=null;
    function save(){ saveAs(cv.toDataURL("image/png", 1.0), "QSL_MASTER_V18.png"); }
    window.onload=()=>{ bg.src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=1800"; bg.onload=draw; };
</script>
</body>
</html>
