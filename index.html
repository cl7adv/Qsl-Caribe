<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSL ELITE v28.0 - INTERACTIVE GLOBAL - CL7ADV</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg-deep: #020408; --panel-bg: #0d1117; --neon-cyan: #00f2ff;
            --neon-pink: #ff007b; --text-main: #e6edf3; --border-color: #30363d;
        }

        #orientation-warning {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; color: var(--neon-cyan);
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; font-family: sans-serif;
        }

        @media screen and (max-width: 900px) and (orientation: portrait) {
            #orientation-warning { display: flex; }
        }

        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 1s;
        }

        .cl7adv-pulse {
            font-size: 5rem; font-weight: 900; color: var(--neon-cyan);
            text-shadow: 0 0 20px var(--neon-cyan);
            animation: pulse 2s infinite alternate;
        }

        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }

        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg-deep);
            color: var(--text-main); margin: 0; display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }

        header {
            background: #161b22; border-bottom: 2px solid var(--neon-cyan);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
        }

        .app-container { display: flex; flex: 1; overflow: hidden; }

        .sidebar {
            width: 400px; background: var(--panel-bg); border-right: 1px solid var(--border-color);
            padding: 15px; overflow-y: auto; box-sizing: border-box;
        }

        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--neon-cyan); }

        .control-section {
            background: rgba(255,255,255,0.02); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px; margin-bottom: 12px;
        }

        .section-title { color: var(--neon-pink); font-size: 0.7rem; font-weight: 900; margin-bottom: 8px; text-transform: uppercase; }

        input, select {
            width: 100%; background: #010409; border: 1px solid var(--border-color);
            border-radius: 4px; padding: 8px; color: #fff; margin-bottom: 5px; font-size: 0.8rem;
        }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .btn {
            width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: 800;
            cursor: pointer; text-transform: uppercase; margin-top: 5px; transition: 0.2s;
        }

        .btn-primary { background: var(--neon-cyan); color: #000; }
        .btn-dark { background: #21262d; color: #fff; border: 1px solid var(--border-color); }
        .btn:hover { filter: brightness(1.2); }

        .preview-area { flex: 1; background: #000; display: flex; justify-content: center; align-items: center; position: relative; }
        canvas { cursor: move; max-width: 95%; max-height: 95%; border: 1px solid #333; }
        
        #indicator {
            position: absolute; bottom: 10px; left: 10px; font-size: 10px;
            color: var(--neon-cyan); background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;
        }
    </style>
</head>
<body onload="initApp()">

<div id="orientation-warning">
    <div style="font-size: 50px;">üîÑ</div>
    <h2>GIRA EL M√ìVIL</h2>
    <p>USA ESTA APP EN MODO HORIZONTAL</p>
</div>

<div id="intro-overlay">
    <div style="color:white; letter-spacing: 5px; font-size: 14px;">RADIO CLUB SANTA CRUZ DEL SUR</div>
    <div class="cl7adv-pulse">CL7ADV</div>
    <div style="color:var(--neon-pink); margin-top:10px; font-family: monospace;">MOTOR GLOBAL v28.0</div>
</div>

<header>
    <div style="font-weight: 900; color: var(--neon-cyan);">QSL ELITE <span style="font-weight:100; color:#fff;">| CL7ADV</span></div>
    <div id="clock" style="font-family: monospace; color: var(--neon-cyan);">00:00:00 UTC</div>
</header>

<div class="app-container">
    <div class="sidebar">
        <div class="control-section">
            <div class="section-title">FONDO DE ESTACI√ìN</div>
            <input type="file" id="bgInp" accept="image/*">
            <button class="btn btn-dark" onclick="resetBg()">LIMPIAR IMAGEN</button>
        </div>

        <div class="control-section">
            <div class="section-title">MI INDICATIVO Y PA√çS</div>
            <input type="text" id="myCall" value="CL7ADV" placeholder="TU CALL">
            <input type="text" id="myQth" value="CUBA" placeholder="TU PA√çS">
            <div class="row">
                <div><label style="font-size:9px;">TAMA√ëO CALL</label><input type="range" id="sizeCall" min="50" max="450" value="240"></div>
                <div><label style="font-size:9px;">TAMA√ëO QTH</label><input type="range" id="sizeQth" min="20" max="200" value="90"></div>
            </div>
        </div>

        <div class="control-section">
            <div class="section-title">CARGAR LOG (.ADI)</div>
            <input type="file" id="adiInp" accept=".adi,.adif">
            <div class="row">
                <button class="btn btn-dark" onclick="nav(-1)">ANT.</button>
                <button class="btn btn-dark" onclick="nav(1)">SIG.</button>
            </div>
        </div>

        <div class="control-section">
            <div class="section-title">PALETA DE COLORES</div>
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px;">
                <input type="color" id="col1" value="#ff007b">
                <input type="color" id="col2" value="#00f2ff">
                <input type="color" id="col3" value="#0d1117">
                <input type="color" id="col4" value="#00f2ff">
                <input type="color" id="col5" value="#ffffff">
                <input type="color" id="col6" value="#00f2ff">
            </div>
            <label style="font-size:9px;">OPACIDAD DEL CUADRO</label>
            <input type="range" id="boxAlpha" min="0" max="100" value="90">
        </div>

        <div class="control-section">
            <div class="section-title">DATOS DEL CORRESPONSAL</div>
            <input type="text" id="qCall" placeholder="STATION">
            <div class="row">
                <input type="text" id="qDate" placeholder="FECHA">
                <input type="text" id="qTime" placeholder="HORA">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                <input type="text" id="qBand" placeholder="BAND">
                <input type="text" id="qMode" placeholder="MODE">
                <input type="text" id="qRst" placeholder="RST">
            </div>
        </div>

        <button class="btn btn-primary" onclick="exportJpg()">GUARDAR QSL</button>
        <button class="btn btn-dark" id="zipBtn" style="display:none; margin-top:5px;" onclick="exportZip()">EXPORTAR ZIP COMPLETO</button>
    </div>

    <div class="preview-area">
        <div id="indicator">STANDBY</div>
        <canvas id="cv" width="1800" height="1100"></canvas>
    </div>
</div>

<script>
const cv = document.getElementById('cv'), ctx = cv.getContext('2d');
let bg = new Image(), log = [], idx = 0;

// SISTEMA DRAG & DROP
let elements = {
    myCall: { x: 80, y: 260, dragging: false },
    myQth: { x: 95, y: 380, dragging: false },
    qsoBox: { x: 80, y: 800, w: 1640, h: 210, dragging: false }
};

let offset = { x: 0, y: 0 };

// BASE DE DATOS MASIVA DE PA√çSES (HISPANOS + 30 MUNDIALES)
const DB = {
    'CL':'CUBA','CM':'CUBA','CO':'CUBA','T4':'CUBA',
    'EA':'ESPA√ëA','EB':'ESPA√ëA','EC':'ESPA√ëA','AM':'ESPA√ëA',
    'XE':'M√âXICO','XF':'M√âXICO','6D':'M√âXICO',
    'LU':'ARGENTINA','LW':'ARGENTINA','AY':'ARGENTINA',
    'CE':'CHILE','XR':'CHILE','HK':'COLOMBIA','HJ':'COLOMBIA',
    'YV':'VENEZUELA','4M':'VENEZUELA','OA':'PER√ö','OB':'PER√ö',
    'ZP':'PARAGUAY','CP':'BOLIVIA','HC':'ECUADOR','TG':'GUATEMALA',
    'HR':'HONDURAS','YS':'EL SALVADOR','YN':'NICARAGUA','TI':'COSTA RICA',
    'HP':'PANAM√Å','HI':'REP. DOMINICANA','KP4':'PUERTO RICO','WP4':'PUERTO RICO',
    'CX':'URUGUAY','CV':'URUGUAY',
    'K':'USA','W':'USA','N':'USA','AA':'USA','PY':'BRASIL','PP':'BRASIL',
    'G':'INGLATERRA','M':'INGLATERRA','F':'FRANCIA','I':'ITALIA','DL':'ALEMANIA',
    'JA':'JAP√ìN','VK':'AUSTRALIA','ZL':'NUEVA ZELANDA','BY':'CHINA','UR':'UCRANIA',
    'LY':'LITUANIA','SP':'POLONIA','OK':'REP. CHECA','OM':'ESLOVAQUIA','HA':'HUNGR√çA',
    'S5':'ESLOVENIA','OH':'FINLANDIA','SM':'SUECIA','LA':'NORUEGA','OZ':'DINAMARCA',
    'PA':'PA√çSES BAJOS','ON':'B√âLGICA','HB':'SUIZA','OE':'AUSTRIA','SV':'GRECIA',
    'CT':'PORTUGAL','VU':'INDIA','UA':'RUSIA','E7':'BOSNIA','YO':'RUMAN√çA'
};

function initApp() {
    setTimeout(() => {
        document.getElementById('intro-overlay').style.opacity = 0;
        setTimeout(() => document.getElementById('intro-overlay').style.display = 'none', 1000);
    }, 2500);
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toISOString().substr(11, 8) + " UTC";
    }, 1000);
    setupInteractivity();
    render();
}

function setupInteractivity() {
    const getPos = (e) => {
        const rect = cv.getBoundingClientRect();
        const sx = cv.width / rect.width, sy = cv.height / rect.height;
        return { x: ((e.clientX || e.touches[0].clientX) - rect.left) * sx, y: ((e.clientY || e.touches[0].clientY) - rect.top) * sy };
    };

    const start = (e) => {
        const p = getPos(e);
        if (p.x > elements.myCall.x && p.x < elements.myCall.x + 800 && p.y > elements.myCall.y - 200 && p.y < elements.myCall.y) elements.myCall.dragging = true;
        else if (p.x > elements.qsoBox.x && p.x < elements.qsoBox.x + elements.qsoBox.w && p.y > elements.qsoBox.y && p.y < elements.qsoBox.y + elements.qsoBox.h) elements.qsoBox.dragging = true;
        else if (p.x > elements.myQth.x && p.x < elements.myQth.x + 500 && p.y > elements.myQth.y - 80 && p.y < elements.myQth.y) elements.myQth.dragging = true;
        offset.x = p.x; offset.y = p.y;
    };

    const move = (e) => {
        if (!elements.myCall.dragging && !elements.qsoBox.dragging && !elements.myQth.dragging) return;
        if(e.cancelable) e.preventDefault();
        const p = getPos(e);
        const dx = p.x - offset.x, dy = p.y - offset.y;
        if (elements.myCall.dragging) { elements.myCall.x += dx; elements.myCall.y += dy; }
        if (elements.myQth.dragging) { elements.myQth.x += dx; elements.myQth.y += dy; }
        if (elements.qsoBox.dragging) { elements.qsoBox.x += dx; elements.qsoBox.y += dy; }
        offset.x = p.x; offset.y = p.y;
        render();
    };

    const stop = () => { elements.myCall.dragging = false; elements.myQth.dragging = false; elements.qsoBox.dragging = false; };

    cv.addEventListener('mousedown', start); window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
    cv.addEventListener('touchstart', start); window.addEventListener('touchmove', move, { passive: false }); window.addEventListener('touchend', stop);

    document.querySelectorAll('input').forEach(i => i.oninput = render);
    document.getElementById('myCall').oninput = (e) => {
        const c = e.target.value.toUpperCase(); e.target.value = c;
        document.getElementById('myQth').value = DB[c.substring(0,3)] || DB[c.substring(0,2)] || DB[c.substring(0,1)] || "DESCONOCIDO";
        render();
    };
}

document.getElementById('adiInp').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
        log = ev.target.result.split(/<eor>/i).map(c => {
            if(c.length < 10) return null;
            const f = (t) => { const m = c.match(new RegExp(`<${t}:\\d+>([^<]*)`, "i")); return m ? m[1].trim() : ""; };
            return { call: f('CALL'), date: f('QSO_DATE'), time: f('TIME_ON'), band: f('BAND'), mode: f('MODE'), rst: f('RST_SENT') };
        }).filter(x => x && x.call);
        if(log.length) { idx = 0; document.getElementById('zipBtn').style.display = 'block'; sync(); }
    };
    reader.readAsText(e.target.files[0]);
};

function sync() {
    const q = log[idx];
    document.getElementById('qCall').value = q.call;
    document.getElementById('qBand').value = q.band;
    document.getElementById('qMode').value = q.mode;
    document.getElementById('qRst').value = q.rst;
    document.getElementById('qDate').value = q.date.replace(/(\d{4})(\d{2})(\d{2})/, '$3/$2/$1');
    document.getElementById('qTime').value = q.time.substring(0,2)+":"+q.time.substring(2,4);
    document.getElementById('indicator').innerText = `CONTACTO: ${idx+1} / ${log.length}`;
    render();
}

function nav(d) { if(log.length) { idx = (idx+d+log.length)%log.length; sync(); } }

function render() {
    ctx.clearRect(0,0,1800,1100); ctx.fillStyle = "#000"; ctx.fillRect(0,0,1800,1100);
    if(bg.src) ctx.drawImage(bg, 0, 0, 1800, 1100);

    ctx.save();
    ctx.fillStyle = document.getElementById('col1').value;
    ctx.font = `900 ${document.getElementById('sizeCall').value}px sans-serif`;
    ctx.shadowBlur = 15; ctx.shadowColor = "black";
    ctx.fillText(document.getElementById('myCall').value || "CL7ADV", elements.myCall.x, elements.myCall.y);
    
    ctx.fillStyle = document.getElementById('col2').value;
    ctx.font = `bold ${document.getElementById('sizeQth').value}px sans-serif`;
    ctx.fillText(document.getElementById('myQth').value || "CUBA", elements.myQth.x, elements.myQth.y);
    ctx.restore();

    ctx.save();
    ctx.globalAlpha = document.getElementById('boxAlpha').value / 100;
    ctx.fillStyle = document.getElementById('col3').value;
    ctx.beginPath(); ctx.roundRect(elements.qsoBox.x, elements.qsoBox.y, elements.qsoBox.w, elements.qsoBox.h, 25); ctx.fill();
    ctx.globalAlpha = 1; ctx.strokeStyle = document.getElementById('col4').value;
    ctx.lineWidth = 6; ctx.stroke();

    const d = [
        {l: "CORRESPONSAL", v: document.getElementById('qCall').value},
        {l: "FECHA", v: document.getElementById('qDate').value},
        {l: "HORA", v: document.getElementById('qTime').value},
        {l: "BANDA", v: document.getElementById('qBand').value},
        {l: "MODO", v: document.getElementById('qMode').value},
        {l: "RST", v: document.getElementById('qRst').value}
    ];

    d.forEach((item, i) => {
        let px = elements.qsoBox.x + 50 + (i * 265);
        ctx.fillStyle = document.getElementById('col6').value; ctx.font = "800 22px sans-serif";
        ctx.fillText(item.l, px, elements.qsoBox.y + 65);
        ctx.fillStyle = document.getElementById('col5').value; ctx.font = "bold 55px monospace";
        ctx.fillText(item.v || "---", px, elements.qsoBox.y + 145);
    });
    ctx.restore();
}

document.getElementById('bgInp').onchange = (e) => {
    const r = new FileReader(); r.onload = (ev) => { bg.src = ev.target.result; bg.onload = render; };
    r.readAsDataURL(e.target.files[0]);
};

function resetBg() { bg = new Image(); render(); }

function exportJpg() {
    const a = document.createElement('a'); a.download = `QSL_${document.getElementById('qCall').value}.jpg`;
    a.href = cv.toDataURL('image/jpeg', 0.9); a.click();
}

async function exportZip() {
    const z = new JSZip();
    for(let i=0; i<log.length; i++) {
        idx = i; sync();
        const img = cv.toDataURL('image/jpeg', 0.7).split(',')[1];
        z.file(`${log[i].call}.jpg`, img, {base64: true});
    }
    saveAs(await z.generateAsync({type:"blob"}), "LOG_CL7ADV_GLOBAL.zip");
}
</script>
</body>
</html>
