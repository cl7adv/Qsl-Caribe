<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QSL ELITE PRO v 3.9.2-caribe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@500&family=Audiowide&family=Bungee&family=Permanent+Marker&family=Roboto+Condensed:wght@700&family=Great+Vibes&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: #e2e8f0;
            touch-action: manipulation;
            margin: 0;
            overflow-x: hidden;
        }

        #welcomeScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease-in-out;
        }

        .welcome-content {
            text-align: center;
            animation: fadeInScale 1.5s ease-out;
        }

        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .qsl-wrapper {
            perspective: 1000px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: visible;
        }

        .qsl-container {
            width: 800px;
            height: 514px;
            position: relative;
            overflow: hidden;
            background-color: #1e293b;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            user-select: none;
            border: 1px solid rgba(255,255,255,0.3);
            transform-origin: center;
        }

        @media (max-width: 850px) {
            .qsl-container {
                transform: scale(0.45); 
                margin: -140px 0;
            }
        }

        .inner-border {
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            pointer-events: none;
            z-index: 5;
        }

        #bgLayer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1;
        }

        .draggable {
            position: absolute;
            cursor: move;
            z-index: 10;
            transition: all 0.2s;
            border: 1px dashed transparent;
            touch-action: none;
            padding: 4px;
        }
        .draggable:hover { border-color: rgba(255,255,255,0.4); background-color: rgba(0,0,0,0.1); }
        .draggable:active { cursor: grabbing; border-color: #3b82f6; }

        .qso-table-standard {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #000;
            color: #000;
        }
        .qso-table-standard th, .qso-table-standard td { border: 1px solid #000; }
        .qso-table-standard th { background: rgba(0,0,0,0.1); }

        .glass-effect {
            background: rgba(255, 255, 255, 0.15) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1) !important;
            color: white !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .glass-effect th, .glass-effect td { border: 1px solid rgba(255,255,255,0.3) !important; }
        .glass-effect th { background: rgba(255,255,255,0.1) !important; color: #fbbf24 !important; }

        .qso-table {
            font-family: 'JetBrains Mono', monospace;
            border-collapse: collapse;
            width: 100%;
        }
        .qso-table th, .qso-table td { padding: 6px 12px; text-align: center; }
        .qso-table th { font-size: 10px; text-transform: uppercase; }

        .callsign-main {
            font-family: 'Oswald', sans-serif;
            font-size: 85px;
            line-height: 0.85;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            white-space: nowrap;
        }

        .location-text {
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
            color: white;
            letter-spacing: 1px;
        }

        .badge-elite {
            background: linear-gradient(135deg, #ef4444 0%, #991b1b 100%);
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            font-weight: 900;
            font-style: italic;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            border: 2px solid #fbbf24;
            border-radius: 4px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
            display: inline-block;
            min-width: 50px;
            text-align: center;
        }

        .step-pill { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #334155; font-size: 11px; }
        .step-pill.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .step-content { display: none; }
        .step-content.active { display: block; }

        #toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; display: none; z-index: 10000; }
        
        [contenteditable="true"] { cursor: text; }
        [contenteditable="true"]:focus { 
            outline: 2px dashed #facc15; 
            background: rgba(0,0,0,0.2); 
            border-radius: 4px;
        }

        #qrcode img {
            border: 4px solid white;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        
        .watermark-sig {
            font-family: 'Great Vibes', cursive;
            color: rgba(255,255,255,0.4);
            font-size: 18px;
            pointer-events: none;
        }
        
        /* Marca de agua de ejemplo */
        #exampleStamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 120px;
            font-weight: 900;
            color: rgba(255, 0, 0, 0.15);
            border: 15px solid rgba(255, 0, 0, 0.15);
            padding: 20px;
            text-transform: uppercase;
            pointer-events: none;
            z-index: 100;
            display: none;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="welcomeScreen">
        <div class="welcome-content">
            <h1 class="text-6xl md:text-8xl font-black text-white italic drop-shadow-2xl mb-2">QSL ELITE PRO</h1>
            <p class="text-xl md:text-2xl text-blue-200 font-bold tracking-widest mb-8 uppercase">v 39.2 - Caribbean Master</p>
            <div class="flex flex-col items-center gap-4">
                <button onclick="startApp()" class="px-10 py-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-full transition-all hover:scale-105 shadow-2xl">
                    INICIAR Y CHEQUEAR TARJETA
                </button>
                <p class="text-[10px] text-slate-400 uppercase tracking-tighter">Asegúrese de cargar sus datos antes de exportar</p>
            </div>
        </div>
    </div>

    <header class="bg-slate-900 border-b border-slate-800 flex flex-col md:flex-row items-center justify-between px-4 py-3 gap-4">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-black italic text-blue-400">QSL ELITE PRO <span class="text-[10px] bg-emerald-600 text-white px-2 py-0.5 rounded ml-2">v 39.2</span></h1>
            <div class="h-6 w-px bg-slate-700 hidden md:block"></div>
            <div class="flex gap-2 overflow-x-auto pb-1 max-w-[320px] md:max-w-none">
                <div class="flex items-center gap-1 cursor-pointer" onclick="setStep(1)"><div class="step-pill active" id="pill-1">1</div></div>
                <div class="flex items-center gap-1 cursor-pointer" onclick="setStep(2)"><div class="step-pill" id="pill-2">2</div></div>
                <div class="flex items-center gap-1 cursor-pointer" onclick="setStep(3)"><div class="step-pill" id="pill-3">3</div></div>
                <div class="flex items-center gap-1 cursor-pointer" onclick="setStep(4)"><div class="step-pill" id="pill-4">4</div></div>
                <div class="flex items-center gap-1 cursor-pointer" onclick="setStep(5)"><div class="step-pill" id="pill-5">5</div></div>
                <div class="flex items-center gap-1 cursor-pointer" onclick="setStep(6)"><div class="step-pill" id="pill-6">6</div><span class="text-[10px] font-bold uppercase text-yellow-500">INFO</span></div>
            </div>
        </div>
        <div class="flex gap-2 w-full md:w-auto">
            <button id="prevStep" class="flex-1 md:flex-none px-4 py-2 bg-slate-800 rounded-lg text-xs font-bold opacity-50 cursor-not-allowed">Anterior</button>
            <button id="nextStep" class="flex-1 md:flex-none px-4 py-2 bg-blue-600 rounded-lg text-xs font-bold hover:bg-blue-500">Siguiente</button>
        </div>
    </header>

    <div class="flex flex-1 flex-col md:flex-row overflow-hidden">
        <aside class="w-full md:w-80 bg-slate-900 border-r border-slate-800 p-6 overflow-y-auto max-h-[40vh] md:max-h-none">
            
            <div id="step-1" class="step-content active space-y-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Paso 1: Fondo y Marco</h3>
                <div>
                    <label class="text-[10px] font-bold mb-2 block uppercase text-slate-500">Imágenes Predeterminadas</label>
                    <div class="grid grid-cols-4 gap-2 mb-3" id="thumbContainer"></div>
                    <button onclick="document.getElementById('customBg').click()" class="w-full py-2 border border-dashed border-slate-600 rounded text-xs hover:bg-slate-800">Cargar Imagen Propia</button>
                    <input type="file" id="customBg" class="hidden" accept="image/*">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold mb-2 block uppercase text-slate-500">Color Marco</label>
                        <input type="color" id="borderColor" value="#ffffff" class="h-10 w-full bg-transparent rounded cursor-pointer">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold mb-2 block uppercase text-slate-500">Opacidad Marco</label>
                        <input type="range" id="borderOpacity" min="0" max="100" value="30" class="w-full h-10">
                    </div>
                </div>
            </div>

            <div id="step-2" class="step-content space-y-4">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest text-blue-400">Paso 2: Datos de Estación</h3>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold uppercase text-slate-500">Tu Indicativo (Operador)</label>
                    <input type="text" id="manOpCall" value="CL7ADV" oninput="updateQR()" class="w-full bg-slate-800 border border-slate-700 p-2 text-sm rounded uppercase font-bold text-blue-400">
                    <div class="h-px bg-slate-800 my-4"></div>
                    <input type="text" id="manCall" placeholder="INDICATIVO CORRESPONSAL" class="w-full bg-slate-800 border border-slate-700 p-2 text-sm rounded uppercase">
                    <input type="text" id="manName" placeholder="NOMBRE CORRESPONSAL" class="w-full bg-slate-800 border border-slate-700 p-2 text-sm rounded">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="manDate" class="bg-slate-800 border border-slate-700 p-2 text-sm rounded text-white">
                        <input type="text" id="manTime" placeholder="HORA (UTC)" class="bg-slate-800 border border-slate-700 p-2 text-sm rounded">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="text" id="manFreq" placeholder="FREQ" class="bg-slate-800 border border-slate-700 p-2 text-sm rounded">
                        <input type="text" id="manMode" placeholder="MODO" class="bg-slate-800 border border-slate-700 p-2 text-sm rounded">
                        <input type="text" id="manRst" placeholder="RST" class="bg-slate-800 border border-slate-700 p-2 text-sm rounded">
                    </div>
                    <button onclick="applyManualData()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-xs font-black rounded-lg">APLICAR DATOS</button>
                </div>
            </div>

            <div id="step-3" class="step-content space-y-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Paso 3: Carga de ADIF</h3>
                <input type="file" id="adifInput" accept=".adif,.adi" class="block w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-blue-600 file:text-white cursor-pointer">
                <div id="logInfo" class="hidden text-xs space-y-2 py-4 border-t border-slate-800">
                    <p>Total QSOs: <span id="qsoCount" class="text-blue-400 font-bold">0</span></p>
                </div>
            </div>

            <div id="step-4" class="step-content space-y-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Paso 4: Multimedia y Estilo</h3>
                <div class="bg-slate-800/50 p-4 rounded-lg space-y-4 border border-slate-700">
                    <div class="flex items-center justify-between pb-3 border-b border-slate-700">
                         <label class="text-[10px] font-bold uppercase text-white">Estilo Cristal</label>
                         <input type="checkbox" id="glassToggle" class="w-4 h-4 accent-blue-500">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold mb-2 block uppercase text-slate-500">Logo Personal</label>
                        <button onclick="document.getElementById('logoInput').click()" class="w-full py-2 bg-slate-900 border border-slate-700 rounded text-[10px]">Cargar Logo</button>
                        <input type="file" id="logoInput" class="hidden" accept="image/*">
                        <div class="mt-2">
                             <label class="text-[9px] uppercase text-slate-500">Tamaño Logo</label>
                             <input type="range" id="logoSizeSlider" min="20" max="300" value="80" class="w-full h-6">
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                             <input type="checkbox" id="showLogo" checked class="w-3 h-3">
                             <label for="showLogo" class="text-[10px]">Mostrar Logo</label>
                        </div>
                    </div>
                    <div class="border-t border-slate-700 pt-3">
                        <label class="text-[10px] font-bold mb-2 block uppercase text-slate-500">QR (Tamaño)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="qrSizeInput" value="85" class="w-full h-8 bg-slate-900 border border-slate-700 rounded p-2 text-xs">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="showQR" checked class="w-3 h-3">
                                <label for="showQR" class="text-[10px]">Mostrar QR</label>
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-slate-700 pt-3">
                        <label class="text-[10px] font-bold mb-2 block uppercase text-slate-500">Tipografía Indicativo</label>
                        <select id="fontSelect" class="w-full bg-slate-900 border border-slate-700 p-2 text-xs rounded">
                            <option value="'Oswald', sans-serif">Oswald</option>
                            <option value="'Audiowide', cursive">Audiowide</option>
                            <option value="'Bungee', cursive">Bungee</option>
                            <option value="'Permanent Marker', cursive">Marker</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="color" id="opColor" value="#ffffff" class="h-10 w-full bg-transparent rounded cursor-pointer">
                        <input type="number" id="opSize" value="85" class="w-full h-10 bg-slate-900 border border-slate-700 rounded p-2 text-xs">
                    </div>
                </div>
                <button onclick="resetPositions()" class="w-full py-2 bg-slate-800 text-xs rounded">RESTAURAR POSICIONES</button>
            </div>

            <div id="step-5" class="step-content space-y-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest text-emerald-400">Paso 5: Exportar</h3>
                <button id="downloadBtn" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg uppercase text-sm">Descargar QSL</button>
                <button id="massExportBtn" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg uppercase text-sm">Exportar Lote</button>
            </div>

            <div id="step-6" class="step-content space-y-4">
                <h3 class="text-xs font-bold text-yellow-500 uppercase tracking-widest">Paso 6: Guía de Funciones</h3>
                <div class="text-[11px] text-slate-300 space-y-3 leading-relaxed p-4 bg-slate-800/50 rounded-lg border border-yellow-900/30">
                    <p><span class="text-yellow-500 font-black">CASILLA 1:</span> Gestión visual. Controla el fondo del caribe y el marco de cristal. Ajusta la opacidad para un efecto elegante.</p>
                    <p><span class="text-yellow-500 font-black">CASILLA 2:</span> Entrada manual. Si no tienes ADIF, llena los datos aquí. La fecha se separará automáticamente con <strong class="text-white">AAAA/MM/DD</strong>.</p>
                    <p><span class="text-yellow-500 font-black">CASILLA 3:</span> Potencia ADIF. Carga tus registros de radio y navega entre ellos con el panel inferior.</p>
                    <p><span class="text-yellow-500 font-black">CASILLA 4:</span> Identidad visual. Cambia fuentes, tamaños y activa el <strong class="text-white">Estilo Cristal</strong> para un acabado moderno.</p>
                    <p><span class="text-yellow-500 font-black">CASILLA 5:</span> Salida final. Genera el PNG de alta calidad. <strong class="text-white">RECUERDA:</strong> Chequea que el diseño no oculte datos vitales.</p>
                    <div class="pt-4 border-t border-slate-700 text-center">
                        <p class="text-blue-400 font-black text-lg italic">73's de CL7ADV</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col items-center justify-start md:justify-center bg-black overflow-hidden py-8">
            <div class="qsl-wrapper">
                <div id="qslCapture" class="qsl-container">
                    <div id="exampleStamp">EJEMPLO</div>
                    <div id="borderInner" class="inner-border"></div>
                    <div id="bgLayer" style="background-image: url('https://images.unsplash.com/photo-1500673922987-e212871fec22?auto=format&fit=crop&w=800&q=80');"></div>
                    
                    <div class="draggable" style="top: 40px; left: 40px;" id="dragCall">
                        <h2 id="dispCall" contenteditable="true" class="callsign-main text-white italic">CL7ADV</h2>
                    </div>

                    <div class="draggable flex flex-col items-end" style="top: 40px; right: 40px;" id="dragBadge">
                        <div contenteditable="true" id="dispBadge" class="badge-elite">DX STATION</div>
                    </div>

                    <div class="draggable" style="top: 130px; right: 40px;" id="dragLocation">
                        <div id="dispLocation" contenteditable="true" class="location-text">SANTIAGO DE CUBA, CUBA</div>
                    </div>

                    <div class="draggable" style="top: 140px; left: 40px;" id="dragLogo">
                        <img id="opLogoImg" src="https://via.placeholder.com/80?text=LOGO" class="opacity-90 border-2 border-white/50 rounded-lg shadow-lg" style="width: 80px;">
                    </div>

                    <div class="draggable" style="top: 180px; right: 40px;" id="dragQR">
                        <div id="qrcode" class="bg-white p-1"></div>
                        <div class="text-[8px] text-center bg-black text-white font-bold mt-1">SCAN FOR INFO</div>
                    </div>

                    <div class="draggable" style="bottom: 160px; left: 40px;" id="dragTo">
                        <div id="boxConfirm" class="bg-black/80 text-white p-3 border-l-4 border-red-500 shadow-xl backdrop-blur-sm transition-all duration-300">
                            <div class="text-[9px] uppercase tracking-tighter opacity-70">Confirming QSO with:</div>
                            <div class="flex items-baseline gap-2 flex-wrap">
                                <span id="dispTo" contenteditable="true" class="text-3xl font-black text-yellow-400">W1AW</span>
                                <span id="dispToName" contenteditable="true" class="text-lg font-bold opacity-80 border-b border-red-500 min-w-[50px]">ARRL HQ</span>
                            </div>
                        </div>
                    </div>

                    <div class="draggable" style="bottom: 40px; left: 40px; width: 60%;" id="dragTable">
                        <table class="qso-table qso-table-standard shadow-2xl transition-all duration-300" id="qsoTableUI">
                            <thead>
                                <tr><th>DATE (AAAA/MM/DD)</th><th>TIME (UTC)</th><th>FREQ</th><th>MODE</th><th>RST</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td id="dispDate" contenteditable="true">2024/10/25</td>
                                    <td id="dispTime" contenteditable="true">14:22</td>
                                    <td id="dispFreq" contenteditable="true">14.074</td>
                                    <td id="dispMode" contenteditable="true">FT8</td>
                                    <td id="dispRst" contenteditable="true">-12</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="draggable" style="bottom: 15px; right: 15px; opacity: 0.6;" id="dragWatermark">
                         <div id="dispWatermark" class="watermark-sig text-right">QSL Mngr: CL7ADV</div>
                    </div>
                </div>
            </div>

            <div id="logControls" class="mt-4 flex items-center gap-4 bg-slate-900 px-6 py-3 rounded-full border border-slate-800 hidden scale-75 md:scale-100 z-50">
                <button id="prevBtn" class="hover:text-blue-400 font-bold px-2 text-xl">◀</button>
                <span id="qsoCounter" class="text-xs font-mono text-slate-400">QSO 0 / 0</span>
                <button id="nextBtn" class="hover:text-blue-400 font-bold px-2 text-xl">▶</button>
            </div>
        </main>
    </div>

    <div id="toast" class="bg-slate-800 border border-slate-700 text-white shadow-2xl"></div>

    <script>
        let currentStep = 1;
        let qsoList = [];
        let currentIndex = 0;
        let qr = null;

        function startApp() {
            const screen = document.getElementById('welcomeScreen');
            // Chequeo de seguridad: mostrar marca de ejemplo brevemente
            const stamp = document.getElementById('exampleStamp');
            stamp.style.display = 'block';
            
            showToast("Chequeando integridad del sistema...", "info");
            
            setTimeout(() => {
                stamp.style.display = 'none';
                screen.style.opacity = '0';
                setTimeout(() => {
                    screen.style.display = 'none';
                    showToast("Sistema Listo. ¡Impecable!", "success");
                }, 1000);
            }, 1500);
        }

        function setStep(step) {
            currentStep = step;
            updateSteps();
        }

        function updateSteps() {
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step-pill').forEach(p => p.classList.remove('active'));
            document.getElementById(`step-${currentStep}`).classList.add('active');
            document.getElementById(`pill-${currentStep}`).classList.add('active');
            const btnPrev = document.getElementById('prevStep');
            btnPrev.classList.toggle('opacity-50', currentStep === 1);
            btnPrev.classList.toggle('cursor-not-allowed', currentStep === 1);
        }

        document.getElementById('nextStep').onclick = () => { if(currentStep < 6) { currentStep++; updateSteps(); } };
        document.getElementById('prevStep').onclick = () => { if(currentStep > 1) { currentStep--; updateSteps(); } };

        function updateQR() {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            const size = parseInt(document.getElementById('qrSizeInput').value) || 85;
            const opCall = document.getElementById('manOpCall').value.toUpperCase() || "CL7ADV";
            document.getElementById('dispWatermark').innerText = "QSL Mngr: " + opCall;
            const qrzUrl = `https://www.qrz.com/db/${opCall}`;
            qr = new QRCode(qrContainer, {
                text: qrzUrl,
                width: size,
                height: size,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });
        }

        document.getElementById('qrSizeInput').oninput = updateQR;
        document.getElementById('showQR').onchange = (e) => document.getElementById('dragQR').style.display = e.target.checked ? 'block' : 'none';
        document.getElementById('showLogo').onchange = (e) => document.getElementById('dragLogo').style.display = e.target.checked ? 'block' : 'none';
        document.getElementById('logoSizeSlider').oninput = (e) => document.getElementById('opLogoImg').style.width = e.target.value + 'px';

        document.getElementById('glassToggle').onchange = (e) => {
            const table = document.getElementById('qsoTableUI');
            const confirmBox = document.getElementById('boxConfirm');
            if(e.target.checked) {
                table.classList.remove('qso-table-standard');
                table.classList.add('glass-effect');
                confirmBox.classList.remove('bg-black/80');
                confirmBox.classList.add('glass-effect');
            } else {
                table.classList.add('qso-table-standard');
                table.classList.remove('glass-effect');
                confirmBox.classList.add('bg-black/80');
                confirmBox.classList.remove('glass-effect');
            }
        };

        document.getElementById('fontSelect').onchange = (e) => document.getElementById('dispCall').style.fontFamily = e.target.value;
        document.getElementById('opColor').oninput = (e) => document.getElementById('dispCall').style.color = e.target.value;
        document.getElementById('opSize').oninput = (e) => document.getElementById('dispCall').style.fontSize = e.target.value + 'px';

        document.getElementById('logoInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => document.getElementById('opLogoImg').src = ev.target.result;
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('customBg').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => document.getElementById('bgLayer').style.backgroundImage = `url('${ev.target.result}')`;
                reader.readAsDataURL(file);
            }
        };

        let activeElement = null;
        let offset = { x: 0, y: 0 };

        function startDragging(e, el) {
            if(e.target.getAttribute('contenteditable') === 'true') return;
            activeElement = el;
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const rect = el.getBoundingClientRect();
            const containerRect = document.getElementById('qslCapture').getBoundingClientRect();
            const scaleX = containerRect.width / 800;
            const scaleY = containerRect.height / 514;
            offset.x = (clientX - rect.left) / scaleX;
            offset.y = (clientY - rect.top) / scaleY;
            document.querySelectorAll('.draggable').forEach(d => d.style.zIndex = "10");
            el.style.zIndex = "50";
        }

        function drag(e) {
            if (!activeElement) return;
            e.preventDefault();
            const container = document.getElementById('qslCapture').getBoundingClientRect();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const scaleX = container.width / 800;
            const scaleY = container.height / 514;
            let x = (clientX - container.left) / scaleX - offset.x;
            let y = (clientY - container.top) / scaleY - offset.y;
            activeElement.style.left = x + 'px';
            activeElement.style.top = y + 'px';
            activeElement.style.right = 'auto';
            activeElement.style.bottom = 'auto';
        }

        document.querySelectorAll('.draggable').forEach(el => {
            el.addEventListener('mousedown', (e) => startDragging(e, el));
            el.addEventListener('touchstart', (e) => startDragging(e, el), { passive: false });
        });

        window.addEventListener('mousemove', drag);
        window.addEventListener('touchmove', drag, { passive: false });
        window.addEventListener('mouseup', () => activeElement = null);
        window.addEventListener('touchend', () => activeElement = null);

        function resetPositions() {
            const setPos = (id, t, l, r, b) => {
                const el = document.getElementById(id);
                if(el) { el.style.top = t; el.style.left = l; el.style.right = r; el.style.bottom = b; }
            };
            setPos('dragCall', '40px', '40px', 'auto', 'auto');
            setPos('dragBadge', '40px', 'auto', '40px', 'auto');
            setPos('dragLocation', '130px', 'auto', '40px', 'auto');
            setPos('dragLogo', '140px', '40px', 'auto', 'auto');
            setPos('dragQR', '180px', 'auto', '40px', 'auto');
            setPos('dragTo', 'auto', '40px', 'auto', '160px');
            setPos('dragTable', 'auto', '40px', 'auto', '40px');
            setPos('dragWatermark', 'auto', 'auto', '15px', '15px');
        }

        function formatTime(timeStr) {
            if(!timeStr) return "---";
            let clean = timeStr.replace(/:/g, '').trim();
            if(clean.length >= 4) return clean.slice(0, 2) + ":" + clean.slice(2, 4);
            return timeStr;
        }

        function formatDate(dateStr) {
            if(!dateStr) return "---";
            let clean = dateStr.replace(/[-\/\.]/g, '').trim();
            if(clean.length === 8) {
                return clean.slice(0, 4) + "/" + clean.slice(4, 6) + "/" + clean.slice(6, 8);
            }
            if(dateStr.includes('-')) {
                return dateStr.replace(/-/g, '/');
            }
            return dateStr;
        }

        function applyManualData() {
            const op = document.getElementById('manOpCall').value.toUpperCase();
            if(op) { document.getElementById('dispCall').innerText = op; updateQR(); }
            const call = document.getElementById('manCall').value.toUpperCase();
            if(call) document.getElementById('dispTo').innerText = call;
            document.getElementById('dispToName').innerText = document.getElementById('manName').value;
            document.getElementById('dispDate').innerText = formatDate(document.getElementById('manDate').value);
            document.getElementById('dispTime').innerText = formatTime(document.getElementById('manTime').value);
            document.getElementById('dispFreq').innerText = document.getElementById('manFreq').value || '---';
            document.getElementById('dispMode').innerText = document.getElementById('manMode').value || '---';
            document.getElementById('dispRst').innerText = document.getElementById('manRst').value || '---';
            showToast("Datos aplicados", "success");
        }

        document.getElementById('borderColor').oninput = document.getElementById('borderOpacity').oninput = updateBorderStyle;

        function updateBorderStyle() {
            const color = document.getElementById('borderColor').value;
            const alpha = document.getElementById('borderOpacity').value / 100;
            document.getElementById('qslCapture').style.borderColor = `rgba(${parseInt(color.slice(1,3), 16)},${parseInt(color.slice(3,5), 16)},${parseInt(color.slice(5,7), 16)},${alpha})`;
        }

        document.getElementById('adifInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => parseADIF(event.target.result);
            reader.readAsText(file);
        });

        function parseADIF(text) {
            const qsos = text.split(/<eor>/i);
            qsoList = [];
            qsos.forEach(qsoText => {
                if(!qsoText.trim()) return;
                const qsoData = {};
                const regex = /<([a-z0-9_]+)(?::\d+)?>([^<]+)/gi;
                let match;
                while ((match = regex.exec(qsoText)) !== null) {
                    qsoData[match[1].toUpperCase()] = match[2].trim();
                }
                if(Object.keys(qsoData).length > 0) qsoList.push(qsoData);
            });
            if (qsoList.length > 0) {
                document.getElementById('logControls').classList.remove('hidden');
                document.getElementById('logInfo').classList.remove('hidden');
                document.getElementById('qsoCount').innerText = qsoList.length;
                loadQSO(0);
                showToast(`Cargados ${qsoList.length} QSOs`, "success");
            }
        }

        function loadQSO(index) {
            currentIndex = index;
            const qso = qsoList[index];
            document.getElementById('dispTo').innerText = qso.CALL || '---';
            document.getElementById('dispToName').innerText = qso.NAME || '';
            document.getElementById('dispDate').innerText = formatDate(qso.QSO_DATE || qso.DATE || '');
            document.getElementById('dispTime').innerText = formatTime(qso.TIME_ON || qso.TIME_OFF || '');
            document.getElementById('dispFreq').innerText = qso.FREQ || qso.BAND || '---';
            document.getElementById('dispMode').innerText = qso.MODE || '---';
            document.getElementById('dispRst').innerText = qso.RST_SENT || '---';
            document.getElementById('qsoCounter').innerText = `QSO ${index + 1} DE ${qsoList.length}`;
        }

        document.getElementById('downloadBtn').onclick = () => exportQSL(document.getElementById('dispTo').innerText);

        async function exportQSL(name) {
            showToast("Generando QSL...");
            document.querySelectorAll('.draggable').forEach(d => d.style.border = 'none');
            const canvas = await html2canvas(document.getElementById('qslCapture'), { useCORS: true, scale: 3 });
            const link = document.createElement('a');
            link.download = `QSL_${name}.png`;
            link.href = canvas.toURL ? canvas.toDataURL('image/png') : canvas.toDataURL();
            link.click();
            document.querySelectorAll('.draggable').forEach(d => d.style.border = '');
            showToast("Descarga completada", "success");
        }

        document.getElementById('massExportBtn').onclick = async () => {
            if(!qsoList.length) return;
            if(!confirm(`¿Exportar ${qsoList.length} QSLs en serie?`)) return;
            for(let i=0; i < qsoList.length; i++) {
                loadQSO(i);
                await new Promise(r => setTimeout(r, 1000));
                await exportQSL(qsoList[i].CALL || `QSO_${i}`);
            }
        };

        document.getElementById('nextBtn').onclick = () => { if(currentIndex < qsoList.length-1) loadQSO(currentIndex+1); };
        document.getElementById('prevBtn').onclick = () => { if(currentIndex > 0) loadQSO(currentIndex-1); };

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            t.className = `fixed bottom-5 right-5 p-4 rounded-lg text-white z-[10000] shadow-2xl font-bold transition-all ${type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
            setTimeout(() => t.style.display = 'none', 3000);
        }

        window.onload = () => {
            const thumbs = ['https://images.unsplash.com/photo-1500673922987-e212871fec22?auto=format&fit=crop&w=400&q=80', 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&w=400&q=80', 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?auto=format&fit=crop&w=400&q=80', 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=400&q=80'];
            thumbs.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'h-10 w-full object-cover rounded cursor-pointer border-2 border-transparent hover:border-blue-500 hover:scale-105 transition-transform';
                img.onclick = () => document.getElementById('bgLayer').style.backgroundImage = `url('${url}')`;
                document.getElementById('thumbContainer').appendChild(img);
            });
            updateQR();
        };
    </script>
</body>
</html>
