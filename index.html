<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QSL ELITE v11.0 - ADIF Automation</title>
    <style>
        :root {
            --bg-dark: #0e2431;
            --neon-green: #00ff99;
            --neon-pink: #ff00ff;
            --text-light: #e6faff;
        }

        body {
            font-family: 'Verdana', sans-serif;
            background-color: #050a14; color: var(--text-light);
            margin: 0; display: flex; flex-direction: column; align-items: center;
        }

        header { 
            padding: 15px; text-align: center; width: 100%; 
            background: var(--bg-dark); border-bottom: 2px solid var(--neon-green);
        }

        .main-container {
            display: flex; flex-direction: row; gap: 20px;
            padding: 20px; max-width: 1400px; width: 100%; box-sizing: border-box;
        }

        .controls-panel {
            flex: 0 0 320px; background: var(--bg-dark);
            padding: 20px; border-radius: 12px; border: 2px solid var(--neon-green);
            height: 85vh; overflow-y: auto;
        }

        .section-label {
            color: var(--neon-green); font-size: 0.8em; margin-top: 15px;
            margin-bottom: 8px; display: block; border-bottom: 1px solid #333;
            text-transform: uppercase; font-weight: bold;
        }

        input[type="text"], input[type="date"], input[type="time"], input[type="file"], select {
            width: 100%; padding: 8px; background: #050a14; border: 1px solid var(--neon-green);
            border-radius: 6px; color: white; margin-bottom: 8px; font-size: 0.85em; box-sizing: border-box;
        }

        .btn-action {
            width: 100%; padding: 12px; font-weight: bold; border: none; border-radius: 6px;
            cursor: pointer; text-transform: uppercase; margin-bottom: 10px;
        }
        .btn-download { background: var(--neon-green); color: #000; }
        .btn-adif { background: var(--neon-pink); color: #fff; }

        .preview-panel { flex: 1; display: flex; flex-direction: column; align-items: center; }
        canvas { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--neon-green); }

        /* Estilos galer칤a */
        .gallery-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .gallery-item { width: 100%; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .gallery-item.active { border-color: var(--neon-pink); }

        .adif-status { font-size: 0.75em; color: var(--neon-green); margin-bottom: 10px; background: rgba(0,0,0,0.4); padding: 5px; border-radius: 4px; display: none;}
    </style>
</head>
<body>

    <header><h1 style="margin:0; color:var(--neon-green); font-size: 1.4rem;">QSL CARIBE칌O v11.0 游니 BATCH</h1></header>

    <div class="main-container">
        <div class="controls-panel">
            <span class="section-label">1. Automatizaci칩n ADIF</span>
            <input type="file" id="adifInput" accept=".adi,.adif" onchange="handleADIF(event)">
            <div id="adifStatus" class="adif-status"></div>
            <button class="btn-action btn-adif" id="btnBatch" style="display:none;" onclick="processBatch()">Generar Todas las QSLs</button>

            <span class="section-label">2. Dise침o y Fondo</span>
            <div class="gallery-grid">
                <img class="gallery-item" src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=400" onclick="changeBG(this)">
                <img class="gallery-item" src="https://images.unsplash.com/photo-1519046904884-53103b34b206?q=80&w=400" onclick="changeBG(this)">
            </div>
            <input type="file" id="bgInput" accept="image/*">

            <select id="tableStyle" onchange="draw()">
                <option value="modern">Modo Moderno</option>
                <option value="normal" selected>Modo Normal</option>
                <option value="transparent">Modo Transparente</option>
            </select>

            <span class="section-label">3. Mis Datos</span>
            <input type="text" id="myCall" value="CL7ADV" placeholder="Mi Indicativo" oninput="draw()">
            <input type="text" id="myLocator" value="EL98xx" placeholder="Mi Locator" oninput="draw()">

            <span class="section-label">4. Datos QSO (Manual)</span>
            <input type="text" id="toCall" placeholder="Indicativo Destino" oninput="draw()">
            <input type="date" id="qDate" oninput="draw()">
            <input type="text" id="qBand" placeholder="Banda (ej. 40m)" oninput="draw()">
            <input type="text" id="qMode" placeholder="Modo (ej. FT8)" oninput="draw()">

            <button class="btn-action btn-download" onclick="downloadSingle()">Descargar Actual</button>
        </div>

        <div class="preview-panel">
            <canvas id="qslCanvas" width="900" height="550"></canvas>
            <p style="font-size: 0.7rem; color: #8b949e; margin-top: 10px;">游눠 Arrastra elementos en el canvas para reubicar.</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('qslCanvas');
        const ctx = canvas.getContext('2d');
        let bgImg = new Image();
        bgImg.crossOrigin = "anonymous";
        let adifRecords = [];

        // Configuraci칩n inicial de posiciones
        let posMyCall = { x: 50, y: 110 };
        let posDataBox = { x: 60, y: 380 };
        let dragTarget = null;
        let offset = { x: 0, y: 0 };

        // --- L칍GICA ADIF ---
        function handleADIF(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                adifRecords = parseADIF(text);
                const status = document.getElementById('adifStatus');
                status.style.display = 'block';
                status.innerText = `Cargados: ${adifRecords.length} contactos.`;
                if(adifRecords.length > 0) {
                    document.getElementById('btnBatch').style.display = 'block';
                    fillFormWithRecord(adifRecords[0]); // Carga el primero para vista previa
                }
            };
            reader.readAsText(file);
        }

        function parseADIF(text) {
            const records = [];
            const parts = text.split(/<eor>|<EOR>/i);
            parts.forEach(part => {
                if (!part.trim()) return;
                const record = {};
                const fields = ["CALL", "QSO_DATE", "TIME_ON", "BAND", "MODE", "RST_SENT"];
                fields.forEach(f => {
                    const regex = new RegExp(`<${f}:(\\d+)>([^<]*)`, "i");
                    const match = part.match(regex);
                    if (match) record[f] = match[2].trim();
                });
                if (record.CALL) records.push(record);
            });
            return records;
        }

        function fillFormWithRecord(rec) {
            document.getElementById('toCall').value = rec.CALL || "";
            document.getElementById('qBand').value = rec.BAND || "";
            document.getElementById('qMode').value = rec.MODE || "";
            if (rec.QSO_DATE) {
                const d = rec.QSO_DATE;
                document.getElementById('qDate').value = `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}`;
            }
            draw();
        }

        async function processBatch() {
            if(!confirm(`Se van a generar y descargar ${adifRecords.length} im치genes. 쮺ontinuar?`)) return;
            for(let i=0; i < adifRecords.length; i++) {
                fillFormWithRecord(adifRecords[i]);
                await new Promise(r => setTimeout(r, 100)); // Peque침a pausa para render
                downloadSingle(`QSL_${adifRecords[i].CALL}.png`);
            }
        }

        // --- L칍GICA RENDER ---
        function changeBG(el) {
            document.querySelectorAll('.gallery-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            bgImg.src = el.src;
        }

        bgImg.onload = draw;
        
        function draw() {
            ctx.clearRect(0,0,900,550);
            if(bgImg.src) ctx.drawImage(bgImg, 0, 0, 900, 550);

            // Marca de agua sutil
            ctx.globalAlpha = 0.2; ctx.fillStyle = "white"; ctx.font = "10px Arial";
            ctx.fillText("ZMR-ADIF BATCH SYSTEM", 800, 20); ctx.globalAlpha = 1.0;

            // Mi Indicativo
            ctx.fillStyle = document.getElementById('myCall').value ? "#00ff99" : "#555";
            ctx.font = "bold 80px Verdana";
            ctx.shadowColor = "black"; ctx.shadowBlur = 10;
            ctx.fillText(document.getElementById('myCall').value.toUpperCase() || "MYCALL", posMyCall.x, posMyCall.y);
            ctx.font = "25px Verdana";
            ctx.fillText("LOC: " + document.getElementById('myLocator').value.toUpperCase(), posMyCall.x, posMyCall.y + 40);
            ctx.shadowBlur = 0;

            // Tabla
            const style = document.getElementById('tableStyle').value;
            const bw = 780; const bh = 110;
            drawTable(posDataBox.x, posDataBox.y, bw, bh, style);
        }

        function drawTable(x, y, w, h, style) {
            if(style === 'normal') {
                ctx.fillStyle = "rgba(14, 36, 49, 0.85)"; ctx.fillRect(x, y, w, h);
                ctx.strokeStyle = "#00ff99"; ctx.lineWidth = 2; ctx.strokeRect(x, y, w, h);
            } else if(style === 'modern') {
                ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(x, y, w, 30);
                ctx.fillStyle = "rgba(255,255,255,0.9)"; ctx.fillRect(x, y+30, w, 50);
                ctx.strokeStyle = "white"; ctx.strokeRect(x, y, w, 100);
            }

            // Datos
            ctx.fillStyle = (style === 'modern') ? "white" : "#00ff99";
            ctx.font = "bold 12px Arial";
            const headers = ["CONTACTO", "FECHA", "BANDA", "MODO"];
            const vals = [
                document.getElementById('toCall').value || "---",
                document.getElementById('qDate').value || "---",
                document.getElementById('qBand').value || "---",
                document.getElementById('qMode').value || "---"
            ];

            headers.forEach((txt, i) => {
                ctx.fillStyle = (style === 'modern') ? "white" : "#00ff99";
                ctx.fillText(txt, x + 20 + (i*180), y + 20);
                ctx.fillStyle = (style === 'modern') ? "black" : "white";
                ctx.font = "bold 18px Courier";
                ctx.fillText(vals[i], x + 20 + (i*180), y + 55);
                ctx.font = "bold 12px Arial";
            });
        }

        function downloadSingle(name) {
            const link = document.createElement('a');
            link.download = name || `QSL_Manual.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // Interacci칩n Drag & Drop b치sica
        canvas.onmousedown = (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            if(mouseX > posDataBox.x && mouseX < posDataBox.x + 500) dragTarget = 'box';
            else if(mouseX > posMyCall.x && mouseX < posMyCall.x + 300) dragTarget = 'call';
        };

        window.onmousemove = (e) => {
            if(!dragTarget) return;
            const rect = canvas.getBoundingClientRect();
            if(dragTarget === 'box') {
                posDataBox.x = (e.clientX - rect.left) * (canvas.width / rect.width) - 50;
                posDataBox.y = (e.clientY - rect.top) * (canvas.height / rect.height) - 20;
            } else {
                posMyCall.x = (e.clientX - rect.left) * (canvas.width / rect.width) - 50;
                posMyCall.y = (e.clientY - rect.top) * (canvas.height / rect.height) - 10;
            }
            draw();
        };

        window.onmouseup = () => dragTarget = null;

        window.onload = () => changeBG(document.querySelector('.gallery-item'));
    </script>
</body>
</html>
