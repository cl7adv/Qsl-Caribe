<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSL ELITE HYPER-STUDIO v26.0 - AUTO-COUNTRY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root {
            --bg-deep: #05070a;
            --panel-bg: #0d1117;
            --neon-cyan: #00f2ff;
            --neon-pink: #ff007b;
            --text-main: #e6edf3;
            --border-color: #30363d;
        }

        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: var(--neon-cyan);
            font-family: 'Courier New', monospace; transition: opacity 1.5s ease;
        }
        .scanner { width: 300px; height: 2px; background: var(--neon-cyan); box-shadow: 0 0 20px var(--neon-cyan); animation: scan 2s infinite; }
        @keyframes scan { 0% { transform: translateY(-50px); } 100% { transform: translateY(50px); } }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-deep); color: var(--text-main);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        header {
            background: #161b22; border-bottom: 3px solid var(--neon-cyan);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
        }

        .app-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 380px; background: var(--panel-bg); border-right: 1px solid var(--border-color); padding: 15px; overflow-y: auto; }
        .control-section { background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; margin-bottom: 15px; }
        .section-header { font-size: 0.75rem; font-weight: 800; color: var(--neon-pink); text-transform: uppercase; margin-bottom: 10px; }

        input[type="text"], input[type="file"], select {
            width: 100%; background: #010409; border: 1px solid var(--border-color);
            border-radius: 6px; padding: 8px; color: white; font-size: 0.85rem; box-sizing: border-box; margin-bottom: 5px;
        }

        .btn { width: 100%; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; margin-top: 5px; }
        .btn-primary { background: var(--neon-cyan); color: #000; }
        .btn-secondary { background: var(--neon-pink); color: #fff; }
        .btn-danger { background: #830000; color: #fff; }

        .preview-area { flex: 1; background: #000; display: flex; justify-content: center; align-items: center; position: relative; }
        canvas { max-width: 95%; max-height: 95%; background: #111; }
    </style>
</head>
<body onload="startApp()">

<div id="intro-overlay">
    <h2 id="intro-text">ANALIZANDO BASE DE DATOS MUNDIAL...</h2>
    <div class="scanner"></div>
</div>

<header>
    <h1 style="margin:0; font-size:1.1rem; color:var(--neon-cyan)">QSL ELITE <span style="color:var(--neon-pink)">HYPER-STUDIO v26</span></h1>
    <div id="reloj" style="color:var(--neon-pink); font-weight:bold; font-family:monospace">00:00:00</div>
</header>

<div class="app-container">
    <div class="sidebar">
        <div class="control-section">
            <div class="section-header">üñºÔ∏è Fondo QSL</div>
            <input type="file" id="bgLoader" accept="image/*">
        </div>

        <div class="control-section">
            <div class="section-header">üë§ Mi Estaci√≥n (Auto)</div>
            <input type="text" id="myCall" placeholder="MI INDICATIVO" oninput="handleMyCall(this.value)">
            <input type="text" id="myCountry" placeholder="MI PA√çS" oninput="renderQSL()">
        </div>

        <div class="control-section">
            <div class="section-header">üìú Log ADIF</div>
            <input type="file" id="adifLoader" accept=".adi,.adif">
            <button class="btn btn-danger" onclick="borrarADIF()">BORRAR ARCHIVO LOG</button>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
                <button class="btn btn-dark" onclick="changeQSO(-1)">‚óÄ</button>
                <button class="btn btn-dark" onclick="changeQSO(1)">‚ñ∂</button>
            </div>
        </div>

        <div class="control-section">
            <div class="section-header">üé® Estilo</div>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
                <input type="color" id="cCall" value="#ff007b" oninput="renderQSL()">
                <input type="color" id="cCountry" value="#00f2ff" oninput="renderQSL()">
                <input type="color" id="cBox" value="#0d1117" oninput="renderQSL()">
            </div>
        </div>

        <div class="control-section">
            <div class="section-header">üìù Datos QSO</div>
            <input type="text" id="toCall" placeholder="CORRESPONSAL" oninput="renderQSL()">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <input type="text" id="qDate" placeholder="FECHA">
                <input type="text" id="qTime" placeholder="HORA">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                <input type="text" id="qBand" placeholder="BANDA">
                <input type="text" id="qMode" placeholder="MODO">
                <input type="text" id="qRst" placeholder="RST">
            </div>
        </div>

        <div class="control-section">
            <button class="btn btn-primary" onclick="downloadSingle()">GUARDAR JPG</button>
            <button class="btn btn-secondary" id="btnZip" style="display:none;" onclick="processFullZip()">PACK ZIP</button>
        </div>
    </div>

    <div class="preview-area">
        <canvas id="qslCanvas" width="1800" height="1100"></canvas>
    </div>
</div>

<script>
    const canvas = document.getElementById('qslCanvas'), ctx = canvas.getContext('2d');
    let backgroundImage = new Image(), qsoRecords = [], currentIndex = 0;

    // BASE DE DATOS DE PREFIJOS (+80 pa√≠ses)
    const PREFIJOS = {
        'CL': 'CUBA', 'CM': 'CUBA', 'CO': 'CUBA', 'T4': 'CUBA',
        'EA': 'ESPA√ëA', 'EB': 'ESPA√ëA', 'ED': 'ESPA√ëA',
        'K': 'USA', 'W': 'USA', 'N': 'USA', 'AA': 'USA',
        'G': 'INGLATERRA', 'M': 'INGLATERRA', '2E': 'INGLATERRA',
        'LU': 'ARGENTINA', 'AY': 'ARGENTINA', 'LW': 'ARGENTINA',
        'PY': 'BRASIL', 'ZV': 'BRASIL', 'CE': 'CHILE', 'CA': 'CHILE',
        'CX': 'URUGUAY', 'HK': 'COLOMBIA', 'HJ': 'COLOMBIA',
        'YV': 'VENEZUELA', 'YY': 'VENEZUELA', 'OA': 'PER√ö',
        'ZP': 'PARAGUAY', 'CP': 'BOLIVIA', 'HC': 'ECUADOR',
        'TG': 'GUATEMALA', 'HR': 'HONDURAS', 'YS': 'EL SALVADOR',
        'YN': 'NICARAGUA', 'TI': 'COSTA RICA', 'HP': 'PANAM√Å',
        'XE': 'M√âXICO', 'XF': 'M√âXICO', 'VE': 'CANAD√Å', 'VA': 'CANAD√Å',
        'F': 'FRANCIA', 'I': 'ITALIA', 'DL': 'ALEMANIA', 'DA': 'ALEMANIA',
        'OE': 'AUSTRIA', 'HB': 'SUIZA', 'ON': 'B√âLGICA', 'PA': 'HOLANDA',
        'SM': 'SUECIA', 'LA': 'NORUEGA', 'OH': 'FINLANDIA', 'OZ': 'DINAMARCA',
        'LY': 'LITUANIA', 'YL': 'LETONIA', 'ES': 'ESTONIA', 'UA': 'RUSIA',
        'JA': 'JAP√ìN', 'JH': 'JAP√ìN', 'HL': 'COREA DEL SUR', 'BY': 'CHINA',
        'VK': 'AUSTRALIA', 'ZL': 'NUEVA ZELANDA', 'ZS': 'SUD√ÅFRICA',
        'VU': 'INDIA', '4X': 'ISRAEL', 'E7': 'BOSNIA', '9A': 'CROACIA',
        'S5': 'ESLOVENIA', 'HA': 'HUNGR√çA', 'OK': 'REP. CHECA', 'OM': 'ESLOVAQUIA',
        'SP': 'POLONIA', 'YO': 'RUMANIA', 'LZ': 'BULGARIA', 'SV': 'GRECIA',
        'CT': 'PORTUGAL', 'CU': 'AZORES', 'VR': 'HONG KONG', 'XX': 'MACAO'
    };

    function startApp() {
        setTimeout(() => {
            document.getElementById('intro-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('intro-overlay').style.display = 'none', 1000);
        }, 1500);
        setInterval(() => { document.getElementById('reloj').innerText = new Date().toLocaleTimeString(); }, 1000);
    }

    function handleMyCall(val) {
        val = val.toUpperCase();
        document.getElementById('myCall').value = val;
        // Detectar prefijo (2 letras o 1 letra)
        let country = "";
        if (PREFIJOS[val.substring(0,2)]) country = PREFIJOS[val.substring(0,2)];
        else if (PREFIJOS[val.substring(0,1)]) country = PREFIJOS[val.substring(0,1)];
        
        if(country) document.getElementById('myCountry').value = country;
        renderQSL();
    }

    function parseADIF(text) {
        // Intentar buscar el operador del ADIF
        const opMatch = text.match(/<(?:OPERATOR|STATION_CALLSIGN):\d+>([^<]*)/i);
        if(opMatch) handleMyCall(opMatch[1].trim());

        qsoRecords = text.split(/<eor>/i).filter(r => r.length > 20).map(r => {
            const tags = { CALL:'c', QSO_DATE:'d', TIME_ON:'t', BAND:'b', MODE:'m', RST_SENT:'r' };
            const data = {};
            for(let k in tags) {
                const m = r.match(new RegExp(`<${k}:\\d+>([^<]*)`, "i"));
                if(m) data[tags[k]] = m[1].trim();
            }
            return data;
        }).filter(i => i.c);

        if(qsoRecords.length > 0) {
            document.getElementById('btnZip').style.display = 'block';
            currentIndex = 0; updateFields();
        }
    }

    function borrarADIF() {
        qsoRecords = []; currentIndex = 0;
        document.getElementById('adifLoader').value = "";
        document.getElementById('btnZip').style.display = 'none';
        ['toCall','qDate','qTime','qBand','qMode','qRst'].forEach(id => document.getElementById(id).value = "");
        renderQSL();
    }

    function updateFields() {
        const q = qsoRecords[currentIndex];
        document.getElementById('toCall').value = q.c || "";
        document.getElementById('qBand').value = q.b || "";
        document.getElementById('qMode').value = q.m || "";
        document.getElementById('qRst').value = q.r || "";
        document.getElementById('qDate').value = q.d ? q.d.replace(/(\d{4})(\d{2})(\d{2})/, '$3/$2/$1') : "";
        document.getElementById('qTime').value = q.t ? q.t.substring(0,2)+":"+q.t.substring(2,2) : "";
        renderQSL();
    }

    function renderQSL() {
        ctx.clearRect(0,0,1800,1100);
        if(backgroundImage.src) ctx.drawImage(backgroundImage, 0, 0, 1800, 1100);

        // Mi Estaci√≥n
        ctx.save();
        ctx.shadowBlur = 15; ctx.shadowColor = "black";
        ctx.fillStyle = document.getElementById('cCall').value; ctx.font = "900 200px 'Segoe UI'";
        ctx.fillText(document.getElementById('myCall').value || "CALLSIGN", 100, 250);
        ctx.fillStyle = document.getElementById('cCountry').value; ctx.font = "bold 80px 'Segoe UI'";
        ctx.fillText(document.getElementById('myCountry').value || "PA√çS", 110, 350);
        ctx.restore();

        // Cuadro de Datos
        const w = 1620, h = 180, x = 100, y = 820;
        const op = 0.85;
        ctx.fillStyle = `rgba(13, 17, 23, ${op})`;
        ctx.beginPath(); ctx.roundRect(x, y, w, h, 15); ctx.fill();
        ctx.strokeStyle = document.getElementById('cCountry').value; ctx.lineWidth = 4; ctx.stroke();

        const headers = ["CORRESPONSAL", "FECHA", "HORA", "BANDA", "MODO", "RST"];
        const vals = [document.getElementById('toCall').value, document.getElementById('qDate').value, document.getElementById('qTime').value, document.getElementById('qBand').value, document.getElementById('qMode').value, document.getElementById('qRst').value];
        
        // Espaciado Especial (Dividimos el ancho para separar bien)
        const step = w / 6.2;
        headers.forEach((hd, i) => {
            let posX = x + 40 + (i * step);
            if(i === 5) posX += 30; // M√°s espacio para el RST final

            ctx.fillStyle = document.getElementById('cCountry').value;
            ctx.font = "bold 22px Arial";
            ctx.fillText(hd, posX, y + 45);
            ctx.fillStyle = "white";
            ctx.font = "bold 45px 'Courier New'";
            ctx.fillText(vals[i] || "---", posX, y + 120);
        });
    }

    document.getElementById('bgLoader').onchange = (e) => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader(); r.onload = (v) => { backgroundImage.src = v.target.result; backgroundImage.onload = renderQSL; };
        r.readAsDataURL(f);
    };

    document.getElementById('adifLoader').onchange = (e) => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader(); r.onload = (v) => parseADIF(v.target.result);
        r.readAsText(f);
    };

    function downloadSingle() {
        const link = document.createElement('a');
        link.download = `QSL_${document.getElementById('toCall').value || 'TEST'}.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
    }
</script>
</body>
</html>
