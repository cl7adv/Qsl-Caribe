<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSL ELITE PRO v 4.0.1 / CUBA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Oswald:wght@700&family=Dancing+Script:wght@600&family=Playfair+Display:wght@700&family=Roboto+Mono&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; touch-action: manipulation; }

        /* Area de renderizado: 1650x1050 px (Alta Calidad) */
        #qsl-render-area {
            width: 1650px;
            height: 1050px;
            position: relative;
            overflow: hidden;
            background: #2d3748;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        #qsl-border {
            position: absolute;
            inset: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            pointer-events: none;
            z-index: 10;
        }

        .preview-scale {
            transform: scale(0.4);
            transform-origin: top left;
        }

        @media (max-width: 1024px) { .preview-scale { transform: scale(0.3); } }
        @media (max-width: 768px) { .preview-scale { transform: scale(0.22); } }
        @media (max-width: 480px) { .preview-scale { transform: scale(0.18); } }

        .preview-container {
            width: 100%;
            aspect-ratio: 1650/1050;
            overflow: hidden;
            border-radius: 12px;
            background: #0f172a;
            position: relative;
        }

        .qsl-element { 
            position: absolute; 
            cursor: move; 
            user-select: none; 
            z-index: 20; 
            touch-action: none;
        }

        .font-sans { font-family: 'Inter', sans-serif; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .font-signature { font-family: 'Dancing Script', cursive; }

        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }
        #loader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; align-items: center; justify-content: center; color: white; flex-direction: column; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div id="loader">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 mb-4"></div>
        <p id="loader-text" class="font-bold text-lg text-blue-400 italic text-center px-4">Generando QSLs en Alta Calidad...</p>
    </div>

    <div class="max-w-[1400px] mx-auto p-4">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-blue-600 rounded-2xl shadow-lg shadow-blue-200">
                    <i data-lucide="radio" class="text-white w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-slate-800 tracking-tight">QSL <span class="text-blue-600">ELITE PRO</span> v 4.0.1/CUBA</h1>
                    <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Estudio de Diseño Avanzado</p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="downloadSingleQSL()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-100">
                    <i data-lucide="download" class="w-4 h-4"></i> GUARDAR CALIDAD PRO
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- PANEL DE HERRAMIENTAS -->
            <aside class="lg:col-span-4 space-y-6">
                <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                    <div class="flex bg-slate-50/50">
                        <button onclick="switchTab('design')" id="btn-design" class="flex-1 py-4 text-[10px] uppercase font-bold tracking-widest tab-active">Estilo</button>
                        <button onclick="switchTab('data')" id="btn-data" class="flex-1 py-4 text-[10px] uppercase font-bold tracking-widest text-slate-400">Log ADIF</button>
                    </div>

                    <!-- Pestaña Diseño -->
                    <div id="tab-design" class="p-6 space-y-6">
                        <div class="space-y-4">
                            <label class="text-[11px] font-black text-slate-400 uppercase">Indicativo Personal</label>
                            <input type="text" id="watermark-text" value="CO2KK" oninput="updatePersonalData(this.value)" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 text-xl font-black uppercase focus:border-blue-500 outline-none">
                        </div>

                        <div class="space-y-4">
                            <label class="text-[11px] font-black text-slate-400 uppercase">Comentario Opcional</label>
                            <input type="text" id="comment-input" placeholder="Escribe un mensaje..." oninput="updateComment(this.value)" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-3 text-sm focus:border-blue-500 outline-none">
                            <div class="grid grid-cols-2 gap-2">
                                <div class="space-y-1">
                                    <span class="text-[9px] text-slate-400 uppercase font-bold">Transparencia</span>
                                    <input type="range" min="0" max="1" step="0.1" value="1" oninput="updateCommentOpacity(this.value)" class="w-full">
                                </div>
                                <div class="space-y-1">
                                    <span class="text-[9px] text-slate-400 uppercase font-bold">Color Texto</span>
                                    <input type="color" value="#ffffff" oninput="updateCommentColor(this.value)" class="w-full h-8 cursor-pointer rounded">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <label class="text-[11px] font-black text-slate-400 uppercase">Tipografía y Bordes</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="updateFont('font-oswald')" class="p-3 border rounded-xl text-[10px] font-bold hover:bg-slate-50">OSWALD</button>
                                <button onclick="updateFont('font-serif')" class="p-3 border rounded-xl text-[10px] font-bold hover:bg-slate-50 font-serif">SERIF</button>
                                <button onclick="toggleBorder()" class="p-3 bg-slate-800 text-white rounded-xl text-[10px] font-bold hover:bg-black">BORDE ON/OFF</button>
                                <select onchange="updateTableStyle(this.value)" class="p-3 bg-slate-100 rounded-xl text-[10px] font-bold uppercase cursor-pointer">
                                    <option value="modern">Caja Moderna</option>
                                    <option value="minimal">Minimalista</option>
                                    <option value="classic">Clásico Glass</option>
                                </select>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <label class="text-[11px] font-black text-slate-400 uppercase">Color de Elementos</label>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="updateColor('rgba(255,255,255,0.4)')" class="w-8 h-8 rounded-full bg-white border border-slate-200 shadow-sm"></button>
                                <button onclick="updateColor('rgba(212,175,55,0.7)')" class="w-8 h-8 rounded-full bg-yellow-500"></button>
                                <button onclick="updateColor('rgba(37,99,235,0.7)')" class="w-8 h-8 rounded-full bg-blue-600"></button>
                                <button onclick="updateColor('rgba(239,68,68,0.7)')" class="w-8 h-8 rounded-full bg-red-500"></button>
                                <button onclick="updateColor('rgba(0,0,0,0.6)')" class="w-8 h-8 rounded-full bg-black"></button>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña Datos (mejorada) -->
                    <div id="tab-data" class="p-6 hidden space-y-6">
                        <!-- NUEVA SECCIÓN: ENTRADA MANUAL COMPLETA -->
                        <div class="space-y-4 bg-blue-50/30 p-4 rounded-2xl border border-blue-100">
                            <label class="text-[11px] font-black text-slate-400 uppercase flex items-center gap-2">
                                <i data-lucide="edit" class="w-4 h-4"></i> LLENADO MANUAL DEL QSO
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="manual-call" placeholder="CALL" value="F5ABC" class="text-xs p-3 border rounded-xl outline-none focus:border-blue-400 col-span-2">
                                <input type="text" id="manual-date" placeholder="FECHA (YYYY-MM-DD)" value="2026-02-27" class="text-xs p-3 border rounded-xl outline-none focus:border-blue-400">
                                <input type="text" id="manual-time" placeholder="HORA (HHMM)" value="2245" class="text-xs p-3 border rounded-xl outline-none focus:border-blue-400">
                                <input type="text" id="manual-band" placeholder="BANDA" value="40M" class="text-xs p-3 border rounded-xl outline-none focus:border-blue-400">
                                <input type="text" id="manual-mode" placeholder="MODO" value="FT8" class="text-xs p-3 border rounded-xl outline-none focus:border-blue-400">
                                <input type="text" id="manual-rst" placeholder="RST" value="-01" class="text-xs p-3 border rounded-xl outline-none focus:border-blue-400">
                            </div>
                            <button onclick="applyManualFull()" class="w-full bg-blue-600 text-white p-3 rounded-xl text-[10px] font-bold hover:bg-blue-700 transition-all uppercase tracking-widest">
                                APLICAR AL DISEÑO
                            </button>
                        </div>

                        <!-- IMPORTADOR ADIF -->
                        <button onclick="document.getElementById('adifInput').click()" class="w-full bg-slate-800 text-white p-4 rounded-2xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-slate-900 shadow-lg">
                            <i data-lucide="file-plus" class="w-4 h-4"></i> IMPORTAR ADIF
                        </button>
                        <input type="file" id="adifInput" class="hidden" accept=".adi,.adif" onchange="parseADIF(event)">

                        <!-- LISTA DE CONTACTOS -->
                        <div id="qso-list-container" class="space-y-2">
                            <label class="text-[11px] font-black text-slate-400 uppercase flex justify-between">
                                Contactos <span id="qso-count" class="text-blue-500 font-black">0</span>
                            </label>
                            <div id="qso-list" class="max-h-[300px] overflow-y-auto space-y-1 bg-slate-50 p-2 rounded-xl border border-slate-100">
                                <p class="text-[10px] text-center text-slate-400 py-6 italic">Sin contactos cargados...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="mass-actions" class="hidden">
                    <button onclick="downloadAllQSLs()" class="w-full bg-emerald-600 text-white py-5 rounded-3xl font-black text-sm shadow-xl hover:bg-emerald-700 flex items-center justify-center gap-3 transition-all transform hover:scale-[1.02]">
                        <i data-lucide="archive" class="w-5 h-5"></i> PACK ZIP ALTA CALIDAD
                    </button>
                </div>
            </aside>

            <!-- AREA DE DISEÑO -->
            <main class="lg:col-span-8 space-y-6">
                <div class="bg-white p-2 rounded-[32px] shadow-2xl border border-slate-100">
                    <div class="preview-container" id="container-resize">
                        <div id="qsl-render-area" class="preview-scale">
                            <div id="qsl-border"></div>
                            
                            <!-- FONDO -->
                            <img id="qsl-bg" src="https://images.unsplash.com/photo-1590523277543-a94d2e4eb00b?auto=format&fit=crop&q=80&w=1650" 
                                 onerror="this.parentElement.style.backgroundColor='#1e293b'; this.style.display='none'"
                                 class="absolute inset-0 w-full h-full object-cover">
                            
                            <!-- ELEMENTOS DRAG -->
                            <div id="user-logo-container" class="qsl-element" style="top: 80px; left: 80px; width: 220px;">
                                <img id="user-logo" src="https://upload.wikimedia.org/wikipedia/commons/b/bd/Flag_of_Cuba.svg" class="w-full drop-shadow-2xl">
                                <div id="country-tag" class="mt-2 bg-black/50 backdrop-blur text-white text-xl px-4 py-1 rounded-full inline-block font-bold">CUBA</div>
                            </div>

                            <div id="watermark-el" class="qsl-element font-oswald text-[180px] leading-none opacity-50 uppercase font-black" style="top: 80px; right: 80px; color: white;">
                                CO2KK
                            </div>

                            <!-- COMENTARIO EDITABLE -->
                            <div id="comment-el" class="qsl-element font-sans text-4xl italic font-bold max-w-[600px]" style="top: 300px; left: 80px; color: white; text-shadow: 2px 2px 5px rgba(0,0,0,0.5);">
                                Confirmando nuestro excelente contacto.
                            </div>

                            <div id="signature-el" class="qsl-element font-signature text-[80px]" style="bottom: 320px; right: 100px; color: white; text-shadow: 2px 2px 10px rgba(0,0,0,0.5);">
                                73's de CO2KK
                            </div>

                            <div id="qr-element" class="qsl-element" style="bottom: 80px; right: 80px;">
                                <div id="qr-code-container" class="bg-white p-5 rounded-3xl shadow-2xl"></div>
                            </div>

                            <!-- TABLA DE QSO -->
                            <div id="table-overlay" class="qsl-element bg-white/95 shadow-2xl backdrop-blur-md rounded-3xl overflow-hidden p-6" style="bottom: 80px; left: 80px;">
                                <div id="table-header" class="bg-blue-600 text-white p-5 mb-5 font-black flex justify-between items-center gap-20 text-3xl rounded-2xl">
                                    <div class="flex items-center gap-4">
                                        <i data-lucide="user" class="w-8 h-8"></i>
                                        <span id="lbl-operator">OP: CO2KK</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span id="lbl-qso-with">CONTACTO: <span id="target-call" class="text-yellow-300">DX_STATION</span></span>
                                        <img id="target-flag" src="" class="h-10 rounded shadow-md hidden">
                                    </div>
                                </div>
                                <table class="w-full text-center text-3xl font-bold border-collapse">
                                    <thead>
                                        <tr class="text-slate-500 text-xl border-b-2 border-slate-100">
                                            <th class="pb-4 px-6">FECHA</th>
                                            <th class="pb-4 px-6">HORA UTC</th>
                                            <th class="pb-4 px-6">BANDA</th>
                                            <th class="pb-4 px-6">MODO</th>
                                            <th class="pb-4 px-6">RST</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="pt-6 px-6" id="td-date">2026-02-27</td>
                                            <td class="pt-6 px-6" id="td-time">22:45</td>
                                            <td class="pt-6 px-6" id="td-band">40M</td>
                                            <td class="pt-6 px-6" id="td-mode">FT8</td>
                                            <td class="pt-6 px-6 text-blue-600" id="td-rst">-01</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <button onclick="document.getElementById('bgInput').click()" class="flex flex-col items-center gap-2 p-4 bg-white border border-slate-100 rounded-2xl hover:bg-slate-50 transition-all shadow-sm">
                        <i data-lucide="image" class="text-slate-400"></i>
                        <span class="text-[10px] font-bold uppercase">Cambiar Fondo</span>
                    </button>
                    <button onclick="document.getElementById('logoInput').click()" class="flex flex-col items-center gap-2 p-4 bg-white border border-slate-100 rounded-2xl hover:bg-slate-50 transition-all shadow-sm">
                        <i data-lucide="award" class="text-slate-400"></i>
                        <span class="text-[10px] font-bold uppercase">Cambiar Logo</span>
                    </button>
                    <input type="file" id="bgInput" class="hidden" accept="image/*" onchange="handleImage(event, 'qsl-bg')">
                    <input type="file" id="logoInput" class="hidden" accept="image/*" onchange="handleImage(event, 'user-logo')">
                </div>
            </main>
        </div>
    </div>

    <script>
        let allQsos = [];
        let currentScale = 0.4;

        function updateScale() {
            const container = document.getElementById('container-resize');
            const renderArea = document.getElementById('qsl-render-area');
            const ratio = container.offsetWidth / 1650;
            currentScale = ratio;
            renderArea.style.transform = `scale(${ratio})`;
        }

        window.onload = () => {
            lucide.createIcons();
            updateScale();
            window.addEventListener('resize', updateScale);
            updateQR('https://www.qrz.com/db/CO2KK');
            
            ['user-logo-container', 'table-overlay', 'qr-element', 'watermark-el', 'signature-el', 'comment-el'].forEach(id => {
                makeDraggable(document.getElementById(id));
            });
        };

        function switchTab(tab) {
            document.getElementById('tab-design').classList.toggle('hidden', tab !== 'design');
            document.getElementById('tab-data').classList.toggle('hidden', tab !== 'data');
            document.getElementById('btn-design').className = tab === 'design' ? 'flex-1 py-4 text-[10px] uppercase font-bold tracking-widest tab-active' : 'flex-1 py-4 text-[10px] uppercase font-bold tracking-widest text-slate-400';
            document.getElementById('btn-data').className = tab === 'data' ? 'flex-1 py-4 text-[10px] uppercase font-bold tracking-widest tab-active' : 'flex-1 py-4 text-[10px] uppercase font-bold tracking-widest text-slate-400';
            lucide.createIcons(); // recrear iconos por si acaso
        }

        function updateFont(fontClass) {
            const wm = document.getElementById('watermark-el');
            wm.classList.remove('font-oswald', 'font-serif', 'font-sans');
            wm.classList.add(fontClass);
        }

        function updateColor(color) {
            document.getElementById('watermark-el').style.color = color;
            document.getElementById('qsl-border').style.borderColor = color;
        }

        function toggleBorder() {
            const b = document.getElementById('qsl-border');
            b.style.display = (b.style.display === 'none') ? 'block' : 'none';
        }

        function updateComment(text) {
            document.getElementById('comment-el').textContent = text;
        }

        function updateCommentOpacity(val) {
            document.getElementById('comment-el').style.opacity = val;
        }

        function updateCommentColor(val) {
            document.getElementById('comment-el').style.color = val;
        }

        function updateTableStyle(style) {
            const table = document.getElementById('table-overlay');
            const header = document.getElementById('table-header');
            if(style === 'minimal') {
                table.style.background = 'transparent';
                table.style.boxShadow = 'none';
                table.style.backdropFilter = 'none';
                header.className = "text-white p-5 mb-5 font-black flex justify-between gap-20 text-3xl";
            } else if(style === 'classic') {
                table.style.background = 'rgba(255,255,255,0.4)';
                table.style.backdropFilter = 'blur(30px)';
                header.className = "bg-slate-900 text-white p-5 mb-5 font-black flex justify-between gap-20 text-3xl rounded-2xl";
            } else {
                table.style.background = 'rgba(255,255,255,0.95)';
                table.style.backdropFilter = 'blur(10px)';
                header.className = "bg-blue-600 text-white p-5 mb-5 font-black flex justify-between gap-20 text-3xl rounded-2xl";
            }
        }

        function updatePersonalData(text) {
            const call = text.toUpperCase() || "CO2KK";
            document.getElementById('watermark-el').textContent = call;
            document.getElementById('signature-el').textContent = `73's de ${call}`;
            document.getElementById('lbl-operator').textContent = `OP: ${call}`;
            updateQR(`https://www.qrz.com/db/${call}`);
        }

        function updateQR(url) {
            const container = document.getElementById('qr-code-container');
            container.innerHTML = "";
            new QRCode(container, { text: url, width: 140, height: 140, colorDark : "#0f172a" });
        }

        function handleImage(event, targetId) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById(targetId).src = e.target.result;
                reader.readAsDataURL(file);
            }
        }

        async function parseADIF(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                allQsos = [];
                const records = text.split(/<eor>|<EOR>/i);
                records.forEach(record => {
                    if (record.trim().length < 10) return;
                    const qso = {};
                    const fields = ['CALL', 'QSO_DATE', 'TIME_ON', 'BAND', 'MODE', 'RST_SENT', 'STATION_CALLSIGN', 'COUNTRY'];
                    fields.forEach(f => {
                        const regex = new RegExp('<' + f + ':[0-9]+>(.*?)(?=<|$)', 'i');
                        const match = record.match(regex);
                        if (match) qso[f] = match[1].trim();
                    });
                    if (qso.CALL) allQsos.push(qso);
                });
                
                document.getElementById('qso-count').textContent = allQsos.length;
                displayQSOs();
                document.getElementById('mass-actions').classList.remove('hidden');
                if (allQsos[0]?.STATION_CALLSIGN) updatePersonalData(allQsos[0].STATION_CALLSIGN);
            };
            reader.readAsText(file);
        }

        function displayQSOs() {
            const container = document.getElementById('qso-list');
            container.innerHTML = "";
            allQsos.forEach((qso) => {
                const div = document.createElement('div');
                div.className = "bg-white p-3 border rounded-xl hover:bg-blue-50 cursor-pointer flex justify-between items-center transition-all group";
                div.onclick = () => applyQSO(qso);
                div.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-xs font-black text-slate-700">${qso.CALL}</span>
                        <span class="text-[9px] text-slate-400">${qso.QSO_DATE}</span>
                    </div>
                    <span class="text-[10px] font-bold bg-slate-100 px-2 py-1 rounded group-hover:bg-blue-200">${qso.BAND}</span>
                `;
                container.appendChild(div);
            });
        }

        function applyQSO(qso) {
            document.getElementById('target-call').textContent = qso.CALL;
            document.getElementById('td-date').textContent = qso.QSO_DATE ? qso.QSO_DATE.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3') : '---';
            
            // HORA UTC CON :
            let timeStr = qso.TIME_ON || '0000';
            if(timeStr.length >= 4) {
                timeStr = timeStr.substring(0,2) + ":" + timeStr.substring(2,4);
            }
            document.getElementById('td-time').textContent = timeStr;
            
            document.getElementById('td-band').textContent = qso.BAND || '---';
            document.getElementById('td-mode').textContent = qso.MODE || '---';
            document.getElementById('td-rst').textContent = qso.RST_SENT || '---';
            
            updateFlag(qso.CALL);
        }

        // NUEVA FUNCIÓN PARA APLICAR DATOS MANUALES COMPLETOS
        function applyManualFull() {
            const call = document.getElementById('manual-call').value.toUpperCase() || 'DX_STATION';
            const dateRaw = document.getElementById('manual-date').value;
            const timeRaw = document.getElementById('manual-time').value;
            const band = document.getElementById('manual-band').value || '40M';
            const mode = document.getElementById('manual-mode').value || 'FT8';
            const rst = document.getElementById('manual-rst').value || '-01';

            // Formatear fecha a YYYYMMDD si viene con guiones
            let qsoDate = dateRaw.replace(/-/g, '');
            if (qsoDate.length !== 8) qsoDate = '20260227'; // fallback

            // Formatear hora a 4 dígitos
            let qsoTime = timeRaw.padStart(4, '0').substring(0,4);

            const qso = {
                CALL: call,
                QSO_DATE: qsoDate,
                TIME_ON: qsoTime,
                BAND: band,
                MODE: mode,
                RST_SENT: rst
            };
            applyQSO(qso);
        }

        // NUEVA FUNCIÓN PARA MANEJO DE BANDERAS (MÁS PRECISA)
        function updateFlag(call) {
            const flagImg = document.getElementById('target-flag');
            const code = getCountryCode(call);
            if (code) {
                flagImg.src = `https://flagcdn.com/w80/${code}.png`;
                flagImg.classList.remove('hidden');
                flagImg.onerror = () => {
                    flagImg.classList.add('hidden'); // ocultar si no carga
                };
            } else {
                flagImg.classList.add('hidden');
            }
        }

        function getCountryCode(call) {
            if (!call) return null;
            const c = call.toUpperCase().replace(/[0-9]/g, ''); // eliminar números para prefijo
            
            // Mapa extenso de prefijos a códigos ISO 3166-1 alpha-2
            const prefixMap = {
                // Cuba
                'CM': 'cu', 'CO': 'cu', 'CL': 'cu', 'T4': 'cu',
                // USA
                'K': 'us', 'W': 'us', 'N': 'us', 'AA': 'us', 'AL': 'us', 'NW': 'us',
                // España
                'EA': 'es', 'EB': 'es', 'EC': 'es', 'ED': 'es', 'EE': 'es', 'EF': 'es', 'EG': 'es', 'EH': 'es', 'AM': 'es', 'AN': 'es',
                // Brasil
                'PY': 'br', 'PP': 'br', 'PU': 'br', 'PT': 'br', 'PV': 'br', 'PW': 'br',
                // Reino Unido
                'G': 'gb', 'M': 'gb', '2': 'gb', 'V': 'gb',
                // Italia
                'I': 'it',
                // Francia
                'F': 'fr',
                // Alemania
                'D': 'de', 'Y': 'de',
                // Japón
                'JA': 'jp', 'JE': 'jp', 'JF': 'jp', 'JG': 'jp', 'JH': 'jp', 'JI': 'jp', 'JJ': 'jp', 'JK': 'jp', 'JL': 'jp', 'JM': 'jp', 'JN': 'jp', 'JO': 'jp', 'JP': 'jp', 'JQ': 'jp', 'JR': 'jp', 'JS': 'jp',
                // Argentina
                'LU': 'ar', 'AY': 'ar', 'AZ': 'ar', 'LW': 'ar',
                // Chile (ampliado)
                '3G': 'cl', 'CA': 'cl', 'CB': 'cl', 'CC': 'cl', 'CD': 'cl', 'CE': 'cl', 'XQ': 'cl', 'XR': 'cl',
                // Uruguay
                'CX': 'uy', 'CV': 'uy', 'CW': 'uy',
                // Venezuela
                'YV': 've', 'YX': 've', 'YY': 've',
                // Colombia
                'HK': 'co', 'HJ': 'co',
                // Perú
                'OA': 'pe', 'OB': 'pe', 'OC': 'pe',
                // México
                'XE': 'mx', 'XA': 'mx', 'XB': 'mx',
                // Canadá
                'VE': 'ca', 'VA': 'ca', 'VO': 'ca', 'VY': 'ca', 'CF': 'ca', 'CY': 'ca',
                // Australia
                'VK': 'au',
                // Nueva Zelanda
                'ZL': 'nz',
                // Sudáfrica
                'ZS': 'za', 'ZU': 'za', 'ZV': 'za', 'ZZ': 'za',
                // Rusia
                'R': 'ru', 'UA': 'ru', 'UB': 'ru', 'UC': 'ru', 'UD': 'ru', 'UE': 'ru', 'UF': 'ru', 'UG': 'ru', 'UH': 'ru', 'UI': 'ru', 'UJ': 'ru', 'UL': 'ru', 'UM': 'ru',
                // China
                'B': 'cn',
                // India
                'VU': 'in',
                // Indonesia
                'YB': 'id', 'YC': 'id', 'YD': 'id', 'YE': 'id', 'YF': 'id', 'YG': 'id', 'YH': 'id', 'YI': 'id', 'YJ': 'id', 'YK': 'id',
                // Filipinas
                'DU': 'ph', 'DV': 'ph', 'DW': 'ph', 'DX': 'ph',
                // Tailandia
                'HS': 'th',
                // Malasia
                '9M': 'my',
                // Singapur
                '9V': 'sg',
                // Corea del Sur
                'HL': 'kr',
                // Taiwán
                'BV': 'tw',
                // Israel
                '4X': 'il',
                // Turquía
                'TA': 'tr', 'TB': 'tr', 'TC': 'tr',
                // Grecia
                'SV': 'gr',
                // Polonia
                'SP': 'pl',
                // República Checa
                'OK': 'cz',
                // Eslovaquia
                'OM': 'sk',
                // Hungría
                'HA': 'hu',
                // Rumania
                'YO': 'ro',
                // Bulgaria
                'LZ': 'bg',
                // Serbia
                'YU': 'rs',
                // Croacia
                '9A': 'hr',
                // Eslovenia
                'S5': 'si',
                // Bosnia
                'E7': 'ba',
                // Austria
                'OE': 'at',
                // Suiza
                'HB': 'ch',
                // Países Bajos
                'PA': 'nl', 'PB': 'nl', 'PC': 'nl', 'PD': 'nl', 'PE': 'nl', 'PF': 'nl', 'PG': 'nl', 'PH': 'nl', 'PI': 'nl',
                // Bélgica
                'ON': 'be',
                // Luxemburgo
                'LX': 'lu',
                // Suecia
                'SM': 'se',
                // Noruega
                'LA': 'no', 'LB': 'no', 'LC': 'no', 'LD': 'no', 'LE': 'no', 'LF': 'no', 'LG': 'no',
                // Finlandia
                'OH': 'fi',
                // Dinamarca
                'OU': 'dk', 'OV': 'dk', 'OW': 'dk', 'OX': 'dk', 'OY': 'dk', 'OZ': 'dk',
                // Islandia
                'TF': 'is',
                // Irlanda
                'EI': 'ie', 'EJ': 'ie',
                // Portugal
                'CT': 'pt',
                // Malta
                '9H': 'mt',
                // Chipre
                '5B': 'cy',
                // Emiratos Árabes
                'A6': 'ae',
                // Arabia Saudita
                'HZ': 'sa',
                // Egipto
                'SU': 'eg',
                // Marruecos
                'CN': 'ma',
                // Argelia
                '7X': 'dz',
                // Túnez
                '3V': 'tn',
                // Kenia
                '5Y': 'ke',
                // Nigeria
                '5N': 'ng',
                // Ghana
                '9G': 'gh',
                // Islas Canarias (España)
                'EA8': 'es',
                // Islas Baleares (España)
                'EA6': 'es',
                // Ceuta y Melilla (España)
                'EA9': 'es',
                // Alaska
                'KL': 'us', 'NL': 'us', 'WL': 'us',
                // Hawái
                'KH': 'us',
                // Puerto Rico
                'KP': 'pr', 'WP': 'pr',
                // Islas Vírgenes
                'KV': 'vi',
                // Guam
                'KG': 'gu',
                // Samoa Americana
                'KS': 'as',
                // Costa Rica
                'TI': 'cr', 'TE': 'cr',
                // Panamá
                'HP': 'pa',
                // Guatemala
                'TG': 'gt',
                // Honduras
                'HQ': 'hn',
                // El Salvador
                'YS': 'sv',
                // Nicaragua
                'YN': 'ni',
                // Belice
                'V3': 'bz',
                // República Dominicana
                'HI': 'do',
            };

            // Buscar prefijos de 3 caracteres primero, luego 2, luego 1
            let prefix = c.substring(0,3);
            if (prefixMap[prefix]) return prefixMap[prefix];
            prefix = c.substring(0,2);
            if (prefixMap[prefix]) return prefixMap[prefix];
            prefix = c.substring(0,1);
            if (prefixMap[prefix]) return prefixMap[prefix];
            
            return null; // no encontrado
        }

        function applyManualData() { // se mantiene por compatibilidad, pero usaremos applyManualFull
            const qso = {
                CALL: document.getElementById('m-call').value.toUpperCase() || 'DX_STATION',
                BAND: document.getElementById('m-band').value.toUpperCase() || '40M',
                QSO_DATE: new Date().toISOString().split('T')[0].replace(/-/g,''),
                TIME_ON: '1200',
                MODE: 'FT8',
                RST_SENT: '-01'
            };
            applyQSO(qso);
        }

        async function downloadSingleQSL() {
            const area = document.getElementById('qsl-render-area');
            const call = document.getElementById('target-call').textContent;
            
            // Calidad máxima: scale 2 y desactivar suavizado
            const canvas = await html2canvas(area, { 
                scale: 2, 
                useCORS: true,
                logging: false,
                backgroundColor: null,
                imageTimeout: 0
            });
            
            const link = document.createElement('a');
            link.download = `QSL_CUBA_SPARK_${call}.jpg`;
            link.href = canvas.toDataURL("image/jpeg", 1.0); // Calidad 1.0 (máxima)
            link.click();
        }

        async function downloadAllQSLs() {
            if(allQsos.length === 0) return;
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            const zip = new JSZip();
            const area = document.getElementById('qsl-render-area');
            
            for (let i = 0; i < allQsos.length; i++) {
                applyQSO(allQsos[i]);
                await new Promise(r => setTimeout(r, 150)); // Pausa para que el DOM se actualice
                
                const canvas = await html2canvas(area, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL("image/jpeg", 0.9).split(',')[1];
                zip.file(`QSL_${allQsos[i].CALL}_${i+1}.jpg`, imgData, {base64: true});
                
                document.getElementById('loader-text').textContent = `Procesando: ${i+1} de ${allQsos.length}`;
            }
            
            const content = await zip.generateAsync({type: "blob"});
            saveAs(content, "Galeria_QSL_CubaSpark.zip");
            loader.style.display = 'none';
        }

        function makeDraggable(el) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            el.onmousedown = dragStart;
            el.ontouchstart = dragStart;

            function dragStart(e) {
                const event = e.type === 'touchstart' ? e.touches[0] : e;
                pos3 = event.clientX;
                pos4 = event.clientY;
                
                if (e.type === 'mousedown') {
                    document.onmouseup = dragEnd;
                    document.onmousemove = dragMove;
                } else {
                    document.ontouchend = dragEnd;
                    document.ontouchmove = dragMove;
                }
            }

            function dragMove(e) {
                const event = e.type === 'touchmove' ? e.touches[0] : e;
                pos1 = (pos3 - event.clientX) / currentScale;
                pos2 = (pos4 - event.clientY) / currentScale;
                pos3 = event.clientX;
                pos4 = event.clientY;
                
                el.style.top = (el.offsetTop - pos2) + "px";
                el.style.left = (el.offsetLeft - pos1) + "px";
            }

            function dragEnd() {
                document.onmouseup = null;
                document.onmousemove = null;
                document.ontouchend = null;
                document.ontouchmove = null;
            }
        }
    </script>
</body>
</html>
