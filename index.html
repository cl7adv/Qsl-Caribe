<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSL ELITE PRO v15.0 - GLOBAL MASTER EDITION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0a1921;
            --bg-panel: #0e2431;
            --neon: #00ff99;
            --pink: #ff00ff;
            --light: #e6faff;
            --border: #1a3a4a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #050a14;
            color: var(--light);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        header {
            padding: 20px;
            text-align: center;
            width: 100%;
            background: var(--bg-dark);
            border-bottom: 4px solid var(--neon);
            box-shadow: 0 5px 20px rgba(0, 255, 153, 0.2);
            z-index: 10;
        }

        h1 { margin: 0; letter-spacing: 2px; font-size: 1.8em; text-transform: uppercase; color: var(--neon); }

        .main-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            max-width: 1800px;
            padding: 20px;
            gap: 20px;
            box-sizing: border-box;
        }

        /* Barra Lateral Izquierda */
        .side-bar {
            flex: 0 0 380px;
            background: var(--bg-panel);
            padding: 25px;
            border-radius: 20px;
            border: 2px solid var(--border);
            height: 90vh;
            overflow-y: auto;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }

        .side-bar::-webkit-scrollbar { width: 6px; }
        .side-bar::-webkit-scrollbar-thumb { background: var(--neon); border-radius: 10px; }

        .section-title {
            color: var(--neon);
            font-size: 0.85em;
            margin: 20px 0 10px;
            display: block;
            border-left: 4px solid var(--pink);
            padding-left: 10px;
            text-transform: uppercase;
            font-weight: 800;
        }

        .ctrl-group {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        label {
            font-size: 0.75em;
            color: #88a0b0;
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], input[type="file"], select {
            width: 100%;
            padding: 12px;
            background: #050a14;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-bottom: 12px;
            box-sizing: border-box;
            transition: 0.3s;
        }

        input:focus { border-color: var(--neon); outline: none; box-shadow: 0 0 8px rgba(0, 255, 153, 0.4); }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 18px;
            font-weight: 900;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.4s ease;
            margin: 10px 0;
            letter-spacing: 1px;
        }

        .btn-zip { background: var(--pink); color: white; display: none; box-shadow: 0 0 20px rgba(255, 0, 255, 0.4); }
        .btn-zip:hover { transform: translateY(-3px); box-shadow: 0 5px 25px var(--pink); }

        .btn-previa { background: var(--neon); color: #050a14; }
        .btn-previa:hover { background: #00cc7a; transform: scale(1.02); }

        /* √Årea de Visualizaci√≥n */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        canvas {
            width: 100%;
            max-width: 1100px;
            height: auto;
            border-radius: 15px;
            border: 3px solid var(--neon);
            background: #000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            cursor: crosshair;
        }

        #status-msg {
            margin-top: 15px;
            color: var(--neon);
            font-weight: bold;
            text-shadow: 0 0 5px var(--neon);
        }

        .info-box {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 255, 153, 0.1);
            border: 1px solid var(--neon);
            border-radius: 10px;
            font-size: 0.85em;
            line-height: 1.4;
        }
    </style>
</head>
<body>

<header>
    <h1>QSL ELITE PRO <span style="color:var(--pink)">v15.0</span></h1>
</header>

<div class="main-container">
    <div class="side-bar">
        <span class="section-title">üì¶ Gesti√≥n de Datos</span>
        <div class="ctrl-group">
            <label>Cargar Log ADIF (.adi)</label>
            <input type="file" id="adifInput" accept=".adi,.adif" onchange="handleADIF(event)">
            <button class="btn btn-zip" id="btnZip" onclick="generateAndZip()">Generar Pack Completo (.ZIP)</button>
        </div>

        <span class="section-title">üë§ Mi Estaci√≥n</span>
        <div class="ctrl-group">
            <label>Indicativo Personal</label>
            <input type="text" id="myCall" placeholder="Ej: EA1ABC" oninput="processCallAuto()">
            <label>Pa√≠s (Manual/Auto)</label>
            <input type="text" id="myCountry" placeholder="ESPA√ëA" oninput="draw()">
        </div>

        <span class="section-title">üìê Geometr√≠a del Cuadro QSO</span>
        <div class="ctrl-group">
            <label>Anchura del Cuadro</label>
            <input type="range" id="boxW" min="800" max="1700" value="1620" oninput="draw()">
            <label>Altura del Cuadro</label>
            <input type="range" id="boxH" min="120" max="500" value="180" oninput="draw()">
            <label>Opacidad de Fondo</label>
            <input type="range" id="boxOp" min="0" max="100" value="85" oninput="draw()">
            <label>Grosor de Borde</label>
            <input type="range" id="boxStroke" min="1" max="15" value="4" oninput="draw()">
        </div>

        <span class="section-title">üñºÔ∏è Gesti√≥n de Logos (4 Slots)</span>
        <div id="logosContainer">
            <script>
                for(let i=0; i<4; i++) {
                    document.write(`
                    <div class="ctrl-group">
                        <label>Logo ${i+1}</label>
                        <input type="file" accept="image/*" onchange="loadLogo(${i}, event)">
                        <label>Tama√±o</label>
                        <input type="range" id="size${i}" min="50" max="600" value="180" oninput="draw()">
                    </div>`);
                }
            </script>
        </div>

        <span class="section-title">üì° Datos Manuales del QSO</span>
        <div class="ctrl-group">
            <label>Corresponsal (To Call)</label>
            <input type="text" id="toCall" placeholder="Indicativo Destino" oninput="draw()">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label>Fecha</label><input type="text" id="manDate" placeholder="03/01/2026" oninput="draw()"></div>
                <div><label>Hora (UTC)</label><input type="text" id="manTime" placeholder="14:30" oninput="draw()"></div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                <div><label>Banda</label><input type="text" id="qBand" placeholder="40m" oninput="draw()"></div>
                <div><label>Modo</label><input type="text" id="qMode" placeholder="FT8" oninput="draw()"></div>
                <div><label>RST</label><input type="text" id="qRst" placeholder="599" oninput="draw()"></div>
            </div>
        </div>

        <button class="btn btn-previa" onclick="downloadPreview()">Descargar QSL en Alta Definici√≥n</button>
        
        <div class="info-box">
            <b>Instrucciones:</b><br>
            - Arrastra el indicativo y el cuadro de datos con el rat√≥n.<br>
            - Sube un ADIF para automatizar todo el proceso.<br>
            - Los modos digitales se acortan a <b>DV</b> autom√°ticamente.
        </div>
    </div>

    <div class="canvas-area">
        <canvas id="qslCanvas" width="1800" height="1100"></canvas>
        <p id="status-msg">Esperando interacci√≥n...</p>
    </div>
</div>

<script>
    /* ============================================================
       CONFIGURACI√ìN GLOBAL Y VARIABLES
       ============================================================ */
    const canvas = document.getElementById('qslCanvas');
    const ctx = canvas.getContext('2d');
    let bgImg = new Image(); 
    bgImg.crossOrigin = "anonymous";
    bgImg.src = "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=1800&q=80";

    let adifRecords = [];
    let logos = Array.from({length: 4}, () => ({ img: new Image(), x: 1400, y: 100, active: false }));
    
    // Coordenadas iniciales de elementos movibles
    let posCall = { x: 120, y: 250 };
    let posTable = { x: 100, y: 820 };
    
    // Control de Arrastre
    let dragObj = null;
    let offset = { x: 0, y: 0 };
    let activeLogoIdx = -1;

    /* ============================================================
       BASE DE DATOS DE PREFIJOS (ITU GLOBAL)
       ============================================================ */
    const prefixDB = {
        // Hispanoam√©rica y Espa√±a
        "EA":"SPAIN", "EB":"SPAIN", "EC":"SPAIN", "AM":"SPAIN", "AN":"SPAIN", "AO":"SPAIN",
        "LU":"ARGENTINA", "AY":"ARGENTINA", "AZ":"ARGENTINA", "LO":"ARGENTINA", "LW":"ARGENTINA",
        "CE":"CHILE", "XQ":"CHILE", "3G":"CHILE", "CA":"CHILE",
        "HK":"COLOMBIA", "HJ":"COLOMBIA", "5K":"COLOMBIA",
        "XE":"MEXICO", "XF":"MEXICO", "XG":"MEXICO", "4A":"MEXICO",
        "CL":"CUBA", "CM":"CUBA", "CO":"CUBA", "T4":"CUBA",
        "YV":"VENEZUELA", "YW":"VENEZUELA", "YX":"VENEZUELA", "4M":"VENEZUELA",
        "CX":"URUGUAY", "CV":"URUGUAY", "CW":"URUGUAY",
        "OA":"PERU", "OB":"PERU", "OC":"PERU", "4T":"PERU",
        "ZP":"PARAGUAY", "TI":"COSTA RICA", "TE":"COSTA RICA",
        "TG":"GUATEMALA", "TD":"GUATEMALA", "HR":"HONDURAS", "HQ":"HONDURAS",
        "YS":"EL SALVADOR", "YN":"NICARAGUA", "HT":"NICARAGUA", "HP":"PANAMA", "HO":"PANAMA",
        "HI":"DOMINICAN REP.", "HC":"ECUADOR", "HD":"ECUADOR", "CP":"BOLIVIA",
        "V3":"BELIZE", "3C":"EQUAT. GUINEA", "KP":"PUERTO RICO",
        // Resto del mundo principales
        "W":"USA", "K":"USA", "N":"USA", "AA":"USA", "AK":"USA", "AL":"USA",
        "VE":"CANADA", "VA":"CANADA", "VO":"CANADA", "VY":"CANADA",
        "G":"UNITED KINGDOM", "M":"UNITED KINGDOM", "2E":"UNITED KINGDOM",
        "F":"FRANCE", "TM":"FRANCE", "I":"ITALY", "IK":"ITALY", "IZ":"ITALY",
        "DL":"GERMANY", "DF":"GERMANY", "DK":"GERMANY", "DJ":"GERMANY",
        "JA":"JAPAN", "JH":"JAPAN", "JR":"JAPAN", "JE":"JAPAN",
        "PY":"BRAZIL", "PP":"BRAZIL", "PR":"BRAZIL", "PS":"BRAZIL", "PU":"BRAZIL",
        "RA":"RUSSIA", "UA":"RUSSIA", "UR":"UKRAINE", "CT":"PORTUGAL", "HB":"SWITZERLAND",
        "OE":"AUSTRIA", "LA":"NORWAY", "SM":"SWEDEN", "OH":"FINLAND", "OZ":"DENMARK",
        "PA":"NETHERLANDS", "ON":"BELGIUM", "LX":"LUXEMBOURG", "SV":"GREECE",
        "VK":"AUSTRALIA", "ZL":"NEW ZEALAND", "BY":"CHINA", "VU":"INDIA", "ZS":"SOUTH AFRICA"
    };

    /* ============================================================
       PROCESAMIENTO DE DATOS
       ============================================================ */
    function processCallAuto() {
        const call = document.getElementById('myCall').value.toUpperCase();
        let detected = "RADIO STATION";
        for(let len = 3; len >= 1; len--) {
            let pref = call.substring(0, len);
            if(prefixDB[pref]) { detected = prefixDB[pref]; break; }
        }
        document.getElementById('myCountry').value = detected;
        draw();
    }

    function handleADIF(event) {
        const file = event.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            adifRecords = parseADIF(content);
            
            // Auto-detectar operador
            const opMatch = content.match(/<(?:STATION_CALLSIGN|OPERATOR):\d+>([^<]*)/i);
            if(opMatch) {
                document.getElementById('myCall').value = opMatch[1].trim().toUpperCase();
                processCallAuto();
            }

            if(adifRecords.length > 0) {
                document.getElementById('btnZip').style.display = 'block';
                document.getElementById('status-msg').innerText = `${adifRecords.length} Contactos Detectados.`;
                applyRecordToManual(adifRecords[0]);
            }
        };
        reader.readAsText(file);
    }

    function parseADIF(text) {
        return text.split(/<eor>/i).filter(e => e.trim().length > 15).map(e => {
            const r = {};
            const tags = { CALL:'toCall', QSO_DATE:'d', TIME_ON:'t', BAND:'b', MODE:'m', RST_SENT:'r' };
            for(let key in tags) {
                const match = e.match(new RegExp(`<${key}:\\d+>([^<]*)`, "i"));
                if(match) r[tags[key]] = match[1].trim();
            }
            return r;
        }).filter(item => item.toCall);
    }

    function applyRecordToManual(rec) {
        document.getElementById('toCall').value = rec.toCall || "";
        document.getElementById('qBand').value = rec.b || "";
        document.getElementById('qMode').value = (rec.m && (rec.m.includes('FT') || rec.m.includes('DIG'))) ? "DV" : (rec.m || "");
        document.getElementById('qRst').value = rec.r || "59";
        
        if(rec.d) {
            document.getElementById('manDate').value = `${rec.d.substr(6,2)}/${rec.d.substr(4,2)}/${rec.d.substr(0,4)}`;
        }
        if(rec.t) {
            document.getElementById('manTime').value = `${rec.t.substr(0,2)}:${rec.t.substr(2,2)}`;
        }
        draw();
    }

    /* ============================================================
       MOTOR DE RENDERIZADO (DRAW)
       ============================================================ */
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. Fondo
        if(bgImg.complete) {
            ctx.drawImage(bgImg, 0, 0, 1800, 1100);
        }

        // 2. Logos
        logos.forEach((logo, idx) => {
            if(logo.active) {
                let s = document.getElementById(`size${idx}`).value;
                ctx.drawImage(logo.img, logo.x, logo.y, s, s);
            }
        });

        // 3. Indicativo y Pa√≠s (Mis Datos)
        ctx.save();
        ctx.shadowBlur = 20;
        ctx.shadowColor = "rgba(0,0,0,0.8)";
        
        ctx.fillStyle = "#ff00ff";
        ctx.font = "bold 210px sans-serif";
        ctx.fillText(document.getElementById('myCall').value.toUpperCase() || "RADIO-OP", posCall.x, posCall.y);
        
        ctx.fillStyle = "#00ff99";
        ctx.font = "bold 90px sans-serif";
        ctx.fillText(document.getElementById('myCountry').value.toUpperCase() || "WORLDWIDE", posCall.x + 10, posCall.y + 115);
        ctx.restore();

        // 4. Cuadro de Datos QSO
        const w = parseInt(document.getElementById('boxW').value);
        const h = parseInt(document.getElementById('boxH').value);
        const op = parseInt(document.getElementById('boxOp').value) / 100;
        const stroke = parseInt(document.getElementById('boxStroke').value);

        ctx.save();
        ctx.fillStyle = `rgba(10, 25, 33, ${op})`;
        ctx.fillRect(posTable.x, posTable.y, w, h);
        
        ctx.strokeStyle = "#00ff99";
        ctx.lineWidth = stroke;
        ctx.strokeRect(posTable.x, posTable.y, w, h);
        
        // L√≠nea divisoria cabecera
        ctx.beginPath();
        ctx.moveTo(posTable.x, posTable.y + 60);
        ctx.lineTo(posTable.x + w, posTable.y + 60);
        ctx.stroke();

        // 5. Textos dentro del cuadro
        const labels = ["QSO WITH", "DATE", "TIME (UTC)", "BAND", "MODE", "RST"];
        const vals = [
            document.getElementById('toCall').value || "---",
            document.getElementById('manDate').value || "00/00/00",
            document.getElementById('manTime').value || "00:00",
            document.getElementById('qBand').value || "---",
            document.getElementById('qMode').value || "---",
            document.getElementById('qRst').value || "---"
        ];

        const step = w / 6;
        labels.forEach((lab, i) => {
            // Etiquetas
            ctx.fillStyle = "#00ff99";
            ctx.font = "bold 26px Arial";
            ctx.fillText(lab, posTable.x + 35 + (i * step), posTable.y + 42);
            
            // Valores
            ctx.fillStyle = "white";
            ctx.font = "bold 52px 'Courier New'";
            ctx.fillText(vals[i], posTable.x + 35 + (i * step), posTable.y + 135);
        });
        ctx.restore();
    }

    /* ============================================================
       INTERACCI√ìN Y DESCARGAS
       ============================================================ */
    function loadLogo(idx, e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            logos[idx].img.onload = () => {
                logos[idx].active = true;
                draw();
            };
            logos[idx].img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    async function generateAndZip() {
        const zip = new JSZip();
        document.getElementById('status-msg').innerText = "‚ö° Generando Pack... por favor espere.";
        
        for(let i = 0; i < adifRecords.length; i++) {
            applyRecordToManual(adifRecords[i]);
            await new Promise(res => setTimeout(res, 50)); // Delay para estabilidad
            const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.95));
            zip.file(`QSL_${adifRecords[i].toCall}_${i+1}.png`, blob);
        }

        zip.generateAsync({type:"blob"}).then(content => {
            saveAs(content, `QSL_PACK_${document.getElementById('myCall').value || 'LOG'}.zip`);
            document.getElementById('status-msg').innerText = "‚úÖ ¬°ZIP Descargado con √©xito!";
        });
    }

    function downloadPreview() {
        const link = document.createElement('a');
        link.download = `QSL_${document.getElementById('toCall').value || 'Preview'}.png`;
        link.href = canvas.toDataURL("image/png", 1.0);
        link.click();
    }

    // Eventos de Rat√≥n para Movimiento
    canvas.onmousedown = (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
        const my = (e.clientY - rect.top) * (canvas.height / rect.height);

        // Prioridad logos
        for(let i = 0; i < 4; i++) {
            if(logos[i].active) {
                let s = parseInt(document.getElementById(`size${i}`).value);
                if(mx > logos[i].x && mx < logos[i].x + s && my > logos[i].y && my < logos[i].y + s) {
                    dragObj = 'logo'; activeLogoIdx = i; offset = { x: mx - logos[i].x, y: my - logos[i].y }; return;
                }
            }
        }
        // Cuadro QSO
        if(mx > posTable.x && mx < posTable.x + 1600 && my > posTable.y && my < posTable.y + 300) {
            dragObj = 'table'; offset = { x: mx - posTable.x, y: my - posTable.y };
        }
        // Indicativo
        else if(mx > posCall.x && mx < posCall.x + 800 && my > posCall.y - 150 && my < posCall.y + 50) {
            dragObj = 'call'; offset = { x: mx - posCall.x, y: my - posCall.y };
        }
    };

    window.onmousemove = (e) => {
        if(!dragObj) return;
        const rect = canvas.getBoundingClientRect();
        const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
        const my = (e.clientY - rect.top) * (canvas.height / rect.height);

        if(dragObj === 'logo') { logos[activeLogoIdx].x = mx - offset.x; logos[activeLogoIdx].y = my - offset.y; }
        if(dragObj === 'table') { posTable.x = mx - offset.x; posTable.y = my - offset.y; }
        if(dragObj === 'call') { posCall.x = mx - offset.x; posCall.y = my - offset.y; }
        draw();
    };

    window.onmouseup = () => { dragObj = null; };

    // Inicio
    bgImg.onload = draw;
</script>
</body>
</html>
