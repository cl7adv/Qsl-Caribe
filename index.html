<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSL ELITE v22.0 - AUTO-DV EDITION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root { --bg: #03060e; --panel: #0b121e; --neon: #00f2ff; --pink: #ff007b; --text: #e6edf3; --border: #1f2937; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: #0d1117; border-bottom: 3px solid var(--neon); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 410px; background: var(--panel); border-right: 1px solid var(--border); padding: 18px; overflow-y: auto; scrollbar-width: thin; }
        .sidebar::-webkit-scrollbar { width: 5px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--neon); }
        .ctrl-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 15px; }
        .label-s { font-size: 0.65rem; color: var(--neon); font-weight: 800; text-transform: uppercase; display: block; margin-bottom: 10px; border-bottom: 1px solid #333; }
        label { display: block; font-size: 0.65rem; color: #9ca3af; text-transform: uppercase; margin: 8px 0 4px; }
        input[type="text"], input[type="file"], select { width: 100%; background: #010409; border: 1px solid var(--border); border-radius: 5px; padding: 9px; color: white; font-size: 0.85rem; box-sizing: border-box; }
        input[type="range"] { width: 100%; accent-color: var(--neon); margin: 8px 0; }
        .btn { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; transition: 0.2s; margin-top: 5px; }
        .btn-zip { background: var(--pink); color: white; display: none; }
        .btn-hd { background: var(--neon); color: #000; margin-top: 15px; }
        .btn-nav { background: #1f2937; color: white; width: 48%; display: inline-block; }
        .preview-pane { flex: 1; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding: 20px; }
        canvas { max-width: 100%; max-height: 90vh; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.9); }
        #qso-tag { position: absolute; top: 20px; right: 20px; background: #10b981; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }
    </style>
</head>
<body>

<header>
    <h1 style="margin:0; font-size:1.3rem; letter-spacing:2px;">QSL PRO <span style="color:var(--pink)">v22.0</span></h1>
    <div style="font-size:0.7rem; color:#6b7280;">MODO AUTO-DV ACTIVO</div>
</header>

<div class="main-container">
    <div class="sidebar">
        
        <div class="ctrl-card">
            <span class="label-s">üìÅ ARCHIVO ADIF</span>
            <input type="file" id="adifIn" accept=".adi,.adif" onchange="loadADIF(event)">
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <button class="btn btn-nav" onclick="nav(-1)">‚óÄ PREV</button>
                <button class="btn btn-nav" onclick="nav(1)">NEXT ‚ñ∂</button>
            </div>
            <button class="btn btn-zip" id="bz" onclick="generateZip()">DESCARGAR PACK ZIP</button>
        </div>

        <div class="ctrl-card">
            <span class="label-s">üé® ESTILO DE BLOQUE</span>
            <label>Seleccionar Dise√±o</label>
            <select id="blockMode" onchange="draw()">
                <option value="standard">Dise√±o Est√°ndar (Moderno)</option>
                <option value="compact">Dise√±o Compacto (Limpio)</option>
                <option value="minimal">Dise√±o Minimalista (Sin bordes)</option>
            </select>
        </div>

        <div class="ctrl-card">
            <span class="label-s">üë§ MI ESTACI√ìN</span>
            <label>Indicativo</label>
            <input type="text" id="mCall" placeholder="EA1ABC" oninput="autoDX()">
            <label>Pa√≠s</label>
            <input type="text" id="mCountry" oninput="draw()">
            <label>Fondo</label>
            <input type="file" accept="image/*" onchange="loadBG(event)">
        </div>

        <div class="ctrl-card">
            <span class="label-s">üõ†Ô∏è LOGOS (4 M√ìVILES)</span>
            <script>
                for(let i=0; i<4; i++) {
                    document.write(`
                    <div style="margin-bottom:8px; border-bottom:1px solid #222;">
                        <input type="file" accept="image/*" onchange="loadL(${i}, event)">
                        <input type="range" id="s${i}" min="40" max="600" value="180" oninput="draw()">
                    </div>`);
                }
            </script>
        </div>

        <div class="ctrl-card">
            <span class="label-s">üìê GEOMETR√çA CUADRO</span>
            <label>Ancho</label><input type="range" id="bW" min="800" max="1750" value="1620" oninput="draw()">
            <label>Alto</label><input type="range" id="bH" min="100" max="500" value="180" oninput="draw()">
            <label>Opacidad</label><input type="range" id="bO" min="0" max="100" value="85" oninput="draw()">
            <label>Borde</label><input type="range" id="bS" min="1" max="15" value="4" oninput="draw()">
        </div>

        <div class="ctrl-card">
            <span class="label-s">üì° DATOS QSO ACTUAL</span>
            <input type="text" id="tCall" placeholder="TO CALL" oninput="draw()">
            <div style="display:flex; gap:5px;">
                <input type="text" id="qD" placeholder="FECHA">
                <input type="text" id="qT" placeholder="HORA">
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="qB" placeholder="BANDA">
                <input type="text" id="qM" placeholder="MODO">
                <input type="text" id="qR" placeholder="RST">
            </div>
        </div>

        <button class="btn btn-hd" onclick="saveHQ()">GUARDAR QSL (PNG)</button>
        <div style="height:40px;"></div>
    </div>

    <div class="preview-pane">
        <div id="qso-tag">QSO: 0 / 0</div>
        <canvas id="cv" width="1800" height="1100"></canvas>
    </div>
</div>

<script>
    const cv = document.getElementById('cv'), ctx = cv.getContext('2d');
    let bg = new Image(), logos = Array.from({length:4},()=>({img:new Image(),x:1400,y:100,ok:false}));
    let pC = {x:120,y:250}, pT = {x:100,y:820}, drag=null, off={x:0,y:0}, actL=-1;
    let records = [], cur = 0;

    const PREFIXES = {
        "CA":"CHILE","CB":"CHILE","CC":"CHILE","CD":"CHILE","CE":"CHILE","XQ":"CHILE","XR":"CHILE","3G":"CHILE",
        "LU":"ARGENTINA","LW":"ARGENTINA","AY":"ARGENTINA","AZ":"ARGENTINA","LO":"ARGENTINA","LT":"ARGENTINA",
        "EA":"SPAIN","EB":"SPAIN","EC":"SPAIN","ED":"SPAIN","EE":"SPAIN","EF":"SPAIN","EG":"SPAIN","EH":"SPAIN","AM":"SPAIN","AN":"SPAIN","AO":"SPAIN",
        "W":"USA","K":"USA","N":"USA","AA":"USA","K1":"USA","K2":"USA","K3":"USA","K4":"USA","K5":"USA","K6":"USA","K7":"USA","K8":"USA","K9":"USA","K0":"USA",
        "XE":"MEXICO","XF":"MEXICO","XG":"MEXICO","4A":"MEXICO","HK":"COLOMBIA","HJ":"COLOMBIA","YV":"VENEZUELA","OA":"PERU","CX":"URUGUAY","ZP":"PARAGUAY",
        "TI":"COSTA RICA","TG":"GUATEMALA","HR":"HONDURAS","YS":"EL SALVADOR","YN":"NICARAGUA","HP":"PANAMA","HI":"DOMINICAN REP.","CO":"CUBA","KP":"PUERTO RICO"
        
    };

    function autoDX() {
        const c = document.getElementById('mCall').value.toUpperCase();
        let f = "RADIO STATION";
        for(let i=3; i>=1; i--) { let p=c.substring(0,i); if(PREFIXES[p]) { f=PREFIXES[p]; break; } }
        document.getElementById('mCountry').value = f; draw();
    }

    function loadBG(e) { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(ev)=>{ bg.src=ev.target.result; bg.onload=draw; }; r.readAsDataURL(f); } }
    function loadL(i,e) { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(ev)=>{ logos[i].img.onload=()=>{ logos[i].ok=true; draw(); }; logos[i].img.src=ev.target.result; }; r.readAsDataURL(f); } }

    function loadADIF(e) {
        const f=e.target.files[0]; if(!f) return;
        const r=new FileReader();
        r.onload=(ev)=>{
            const text = ev.target.result;
            records = text.split(/<eor>/i).filter(x=>x.length>20).map(x=>{
                const d = {};
                const tags = {CALL:'c', QSO_DATE:'d', TIME_ON:'t', BAND:'b', MODE:'m', RST_SENT:'r'};
                for(let k in tags){
                    const m = x.match(new RegExp(`<${k}:\\d+>([^<]*)`,"i"));
                    if(m){
                        let v = m[1].trim();
                        // MODO AUTO-DV
                        if(k==='MODE'){
                            const digi = ['FT8','FT4','JS8','JT65','RTTY','PSK','JT9','ARDOP','VARA','SIM31'];
                            if(digi.some(mode => v.toUpperCase().includes(mode))) v = "DV";
                        }
                        d[tags[k]] = v;
                    }
                }
                return d;
            }).filter(d=>d.c);
            cur=0; if(records.length>0){ document.getElementById('bz').style.display='block'; updateFields(); }
        };
        r.readAsText(f);
    }

    function nav(dir) { if(records.length===0) return; cur=(cur+dir+records.length)%records.length; updateFields(); }

    function updateFields() {
        const r = records[cur];
        document.getElementById('tCall').value = r.c || "";
        document.getElementById('qB').value = r.b || "";
        document.getElementById('qM').value = r.m || "";
        document.getElementById('qR').value = r.r || "";
        document.getElementById('qD').value = r.d ? `${r.d.substr(6,2)}/${r.d.substr(4,2)}/${r.d.substr(0,4)}` : "";
        document.getElementById('qT').value = r.t ? `${r.t.substr(0,2)}:${r.t.substr(2,2)}` : "";
        document.getElementById('qso-tag').innerText = `QSO: ${cur+1} / ${records.length}`;
        draw();
    }

    function draw() {
        ctx.clearRect(0,0,1800,1100);
        if(bg.src) ctx.drawImage(bg,0,0,1800,1100);
        logos.forEach((l,i)=>{ if(l.ok) ctx.drawImage(l.img, l.x, l.y, document.getElementById(`s${i}`).value, document.getElementById(`s${i}`).value); });
        
        ctx.save();
        ctx.shadowBlur=20; ctx.shadowColor="black";
        ctx.fillStyle="#ff007b"; ctx.font="900 210px sans-serif";
        ctx.fillText(document.getElementById('mCall').value.toUpperCase()||"CALLSIGN", pC.x, pC.y);
        ctx.fillStyle="#00f2ff"; ctx.font="bold 90px sans-serif";
        ctx.fillText(document.getElementById('mCountry').value.toUpperCase()||"COUNTRY", pC.x+10, pC.y+110);
        ctx.restore();

        const w=parseInt(document.getElementById('bW').value), h=parseInt(document.getElementById('bH').value);
        const o=parseInt(document.getElementById('bO').value)/100, s=parseInt(document.getElementById('bS').value);
        const mode = document.getElementById('blockMode').value;

        ctx.save();
        if(mode !== 'minimal'){
            ctx.fillStyle=`rgba(10,20,30,${o})`;
            ctx.beginPath(); ctx.roundRect(pT.x, pT.y, w, h, 15); ctx.fill();
            ctx.strokeStyle="#00f2ff"; ctx.lineWidth=s; ctx.stroke();
            if(mode === 'standard'){ ctx.beginPath(); ctx.moveTo(pT.x, pT.y+65); ctx.lineTo(pT.x+w, pT.y+65); ctx.stroke(); }
        }

        const labels = ["TO CALL", "DATE", "TIME (UTC)", "BAND", "MODE", "RST"];
        const vals = [document.getElementById('tCall').value, document.getElementById('qD').value, document.getElementById('qT').value, document.getElementById('qB').value, document.getElementById('qM').value, document.getElementById('qR').value];
        const step = w / 6;

        labels.forEach((l, i) => {
            ctx.fillStyle = "#00f2ff"; ctx.font = "800 22px Arial";
            ctx.fillText(l, pT.x+25+(i*step), pT.y+42);
            
            // FECHA M√ÅS PEQUE√ëA PARA QUE QUEPA TODO
            let fSize = (i === 1) ? "bold 38px 'Courier New'" : "bold 50px 'Courier New'";
            ctx.fillStyle = "white"; ctx.font = fSize;
            ctx.fillText(vals[i]||"---", pT.x+25+(i*step), pT.y+130);
        });
        ctx.restore();
    }

    cv.onmousedown=(e)=>{
        const r=cv.getBoundingClientRect(); const mx=(e.clientX-r.left)*(1800/r.width), my=(e.clientY-r.top)*(1100/r.height);
        for(let i=0;i<4;i++){ if(logos[i].ok){ let s=parseInt(document.getElementById(`s${i}`).value); if(mx>logos[i].x && mx<logos[i].x+s && my>logos[i].y && my<logos[i].y+s){ drag='l'; actL=i; off={x:mx-logos[i].x, y:my-logos[i].y}; return; } } }
        if(mx>pT.x && mx<pT.x+parseInt(document.getElementById('bW').value) && my>pT.y && my<pT.y+500){ drag='t'; off={x:mx-pT.x, y:my-pT.y}; }
        else if(mx>pC.x && mx<pC.x+800 && my>pC.y-180 && my<pC.y+50){ drag='c'; off={x:mx-pC.x, y:my-pC.y}; }
    };
    window.onmousemove=(e)=>{
        if(!drag) return; const r=cv.getBoundingClientRect(); const mx=(e.clientX-r.left)*(1800/r.width), my=(e.clientY-r.top)*(1100/r.height);
        if(drag==='l'){ logos[actL].x=mx-off.x; logos[actL].y=my-off.y; }
        if(drag==='t'){ pT.x=mx-off.x; pT.y=my-off.y; }
        if(drag==='c'){ pC.x=mx-off.x; pC.y=my-off.y; }
        draw();
    };
    window.onmouseup=()=>drag=null;

    async function generateZip() {
        const z=new JSZip();
        for(let i=0; i<records.length; i++){
            cur=i; updateFields(); await new Promise(r=>setTimeout(r,80));
            const b=await new Promise(res=>cv.toBlob(res,'image/png',0.95));
            z.file(`QSL_${records[i].c}_${i+1}.png`, b);
        }
        z.generateAsync({type:"blob"}).then(c=>saveAs(c,"PACK_QSL_v22.zip"));
    }
    function saveHQ(){ saveAs(cv.toDataURL("image/png", 1.0), `QSL_${document.getElementById('tCall').value}.png`); }
    window.onload=()=>{ bg.crossOrigin="anonymous"; bg.src="https://images.unsplash.com/photo-1614850523296-d8c1af93d400?w=1800"; bg.onload=draw; };
</script>
</body>
</html>
