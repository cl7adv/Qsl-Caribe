<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSL ELITE v28.0 - CL7ADV GLOBAL EDITION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root {
            --bg-deep: #020408;
            --panel-bg: #0d1117;
            --neon-cyan: #00f2ff;
            --neon-pink: #ff007b;
            --text-main: #e6edf3;
            --border-color: #30363d;
            --header-bg: #161b22;
        }

        /* AVISO DE ORIENTACIÃ“N MÃ“VIL */
        #orientation-warning {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; color: var(--neon-cyan);
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; font-family: sans-serif; padding: 20px;
        }

        @media screen and (max-width: 900px) and (orientation: portrait) {
            #orientation-warning { display: flex; }
        }

        /* ANIMACIÃ“N DE CARGA RADIO CLUB SANTA CRUZ */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 1s;
        }

        .club-name { color: #fff; letter-spacing: 4px; font-size: 1.2rem; margin-bottom: 10px; text-align: center; }
        .cl7adv-title {
            font-size: 5rem; font-weight: 900; color: var(--neon-cyan);
            text-shadow: 0 0 20px var(--neon-cyan);
            animation: pulse 2s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); text-shadow: 0 0 10px var(--neon-cyan); }
            to { transform: scale(1.05); text-shadow: 0 0 40px var(--neon-cyan), 0 0 70px var(--neon-pink); }
        }

        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg-deep);
            color: var(--text-main); margin: 0; display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }

        header {
            background: var(--header-bg); border-bottom: 2px solid var(--neon-cyan);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
        }

        .app-container { display: flex; flex: 1; overflow: hidden; }

        @media (max-width: 900px) {
            .app-container { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100% !important; border-right: none !important; height: auto !important; }
            body { overflow-y: auto; height: auto; }
        }

        .sidebar {
            width: 420px; background: var(--panel-bg); border-right: 1px solid var(--border-color);
            padding: 20px; overflow-y: scroll; box-sizing: border-box;
        }

        .control-section {
            background: rgba(255,255,255,0.02); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }

        .section-header { color: var(--neon-pink); font-weight: 900; font-size: 0.7rem; margin-bottom: 10px; text-transform: uppercase; }
        
        input, select {
            width: 100%; background: #010409; border: 1px solid var(--border-color);
            border-radius: 6px; padding: 10px; color: #fff; margin-bottom: 8px; box-sizing: border-box;
        }

        .btn {
            width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 800;
            cursor: pointer; text-transform: uppercase; margin-top: 5px; transition: 0.3s;
        }

        .btn-primary { background: var(--neon-cyan); color: #000; }
        .btn-secondary { background: var(--neon-pink); color: #fff; }
        .btn-dark { background: #21262d; color: #fff; border: 1px solid var(--border-color); }

        .preview-area { flex: 1; background: #000; display: flex; justify-content: center; align-items: center; position: relative; padding: 20px; }
        canvas { max-width: 100%; max-height: 100%; box-shadow: 0 0 50px #000; border: 1px solid #333; }
        
        #qso-indicator {
            position: absolute; bottom: 20px; left: 20px; border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan); padding: 8px 15px; font-size: 0.7rem; border-radius: 5px; background: rgba(0,0,0,0.5);
        }
    </style>
</head>
<body onload="initHyperStudio()">

<div id="orientation-warning">
    <div style="font-size: 50px;">ðŸ”„</div>
    <h2>GIRA TU DISPOSITIVO</h2>
    <p>USA ESTA APP DE FORMA HORIZONTAL PARA EDITAR TU QSL</p>
</div>

<div id="intro-overlay">
    <div class="club-name">RADIO CLUB SANTA CRUZ DEL SUR</div>
    <div class="cl7adv-title">CL7ADV</div>
    <p id="load-msg" style="color:white; font-family:monospace; margin-top:20px;">CARGANDO PREFIJOS MUNDIALES...</p>
</div>

<header>
    <div style="font-weight: 900; color: var(--neon-cyan);">QSL ELITE HYPER-STUDIO v28.0</div>
    <div id="clock" style="color: var(--neon-cyan); font-family: monospace;">00:00:00</div>
</header>

<div class="app-container">
    <div class="sidebar">
        <div class="control-section">
            <div class="section-header">FONDO QSL</div>
            <input type="file" id="bgLoader" accept="image/*">
            <button class="btn btn-dark" onclick="resetBg()">LIMPIAR IMAGEN</button>
        </div>

        <div class="control-section">
            <div class="section-header">MI ESTACIÃ“N (CL7ADV)</div>
            <input type="text" id="myCall" value="CL7ADV" oninput="updateMyCall()">
            <input type="text" id="myCountry" value="CUBA" oninput="render()">
        </div>

        <div class="control-section">
            <div class="section-header">PROCESAR LOG ADIF</div>
            <input type="file" id="adifLoader" accept=".adi,.adif">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn btn-dark" onclick="move(-1)">ANTERIOR</button>
                <button class="btn btn-dark" onclick="move(1)">SIGUIENTE</button>
            </div>
        </div>

        <div class="control-section">
            <div class="section-header">ESTILO VISUAL</div>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
                <input type="color" id="c1" value="#ff007b" oninput="render()">
                <input type="color" id="c2" value="#00f2ff" oninput="render()">
                <input type="color" id="c3" value="#0d1117" oninput="render()">
                <input type="color" id="c4" value="#00f2ff" oninput="render()">
                <input type="color" id="c5" value="#ffffff" oninput="render()">
                <input type="color" id="c6" value="#00f2ff" oninput="render()">
            </div>
        </div>

        <div class="control-section">
            <div class="section-header">DATOS DEL QSO</div>
            <input type="text" id="tCall" placeholder="CORRESPONSAL" oninput="render()">
            <input type="text" id="tDate" placeholder="FECHA" oninput="render()">
            <input type="text" id="tTime" placeholder="HORA UTC" oninput="render()">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                <input type="text" id="tBand" placeholder="BANDA" oninput="render()">
                <input type="text" id="tMode" placeholder="MODO" oninput="render()">
                <input type="text" id="tRst" placeholder="RST" oninput="render()">
            </div>
        </div>

        <div class="control-section">
            <button class="btn btn-primary" onclick="download()">DESCARGAR JPG</button>
            <button class="btn btn-secondary" id="zipBtn" style="display:none;" onclick="makeZip()">EXPORTAR LOG ZIP</button>
        </div>
    </div>

    <div class="preview-area">
        <div id="qso-indicator">STANDBY</div>
        <canvas id="mainCanvas" width="1800" height="1100"></canvas>
    </div>
</div>

<script>
const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d');
let bg = new Image(), log = [], idx = 0;

// BASE DE DATOS DE PREFIJOS
const PREFIX_DB = {
    // HABLA HISPANA
    'CL':'CUBA', 'CM':'CUBA', 'CO':'CUBA', 'T4':'CUBA',
    'EA':'ESPAÃ‘A', 'EB':'ESPAÃ‘A', 'EC':'ESPAÃ‘A',
    'XE':'MÃ‰XICO', 'XF':'MÃ‰XICO',
    'LU':'ARGENTINA', 'LW':'ARGENTINA', 'AY':'ARGENTINA',
    'CE':'CHILE', 'XR':'CHILE',
    'HK':'COLOMBIA', 'HJ':'COLOMBIA',
    'YV':'VENEZUELA', '4M':'VENEZUELA',
    'OA':'PERÃš', 'OB':'PERÃš',
    'ZP':'PARAGUAY', 'CP':'BOLIVIA', 'HC':'ECUADOR',
    'TG':'GUATEMALA', 'HR':'HONDURAS', 'YS':'EL SALVADOR',
    'YN':'NICARAGUA', 'TI':'COSTA RICA', 'HP':'PANAMÃ',
    'HI':'REP. DOMINICANA', 'KP4':'PUERTO RICO', 'WP4':'PUERTO RICO',
    'CX':'URUGUAY', 'CV':'URUGUAY',
    
    // 30 MÃS ACTIVOS DEL MUNDO
    'K':'USA', 'W':'USA', 'N':'USA', 'AA':'USA',
    'PY':'BRASIL', 'PP':'BRASIL',
    'G':'INGLATERRA', 'M':'INGLATERRA',
    'F':'FRANCIA', 'I':'ITALIA', 'DL':'ALEMANIA',
    'JA':'JAPÃ“N', 'JH':'JAPÃ“N', 'JR':'JAPÃ“N',
    'VK':'AUSTRALIA', 'ZL':'NUEVA ZELANDA',
    'BY':'CHINA', 'UR':'UCRANIA', 'LY':'LITUANIA',
    'SP':'POLONIA', 'OK':'REP. CHECA', 'OM':'ESLOVAQUIA',
    'HA':'HUNGRÃA', 'S5':'ESLOVENIA', 'OH':'FINLANDIA',
    'SM':'SUECIA', 'LA':'NORUEGA', 'OZ':'DINAMARCA',
    'PA':'PAÃSES BAJOS', 'ON':'BÃ‰LGICA', 'HB':'SUIZA',
    'OE':'AUSTRIA', 'SV':'GRECIA', 'CT':'PORTUGAL',
    'VU':'INDIA', 'UA':'RUSIA', 'E7':'BOSNIA', 'YO':'RUMANÃA'
};

function initHyperStudio() {
    setTimeout(() => {
        document.getElementById('intro-overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('intro-overlay').style.display = 'none', 1000);
    }, 3000);
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toISOString().substr(11, 8) + " UTC";
    }, 1000);
    render();
}

function updateMyCall() {
    const val = document.getElementById('myCall').value.toUpperCase();
    document.getElementById('myCall').value = val;
    
    // LÃ³gica de detecciÃ³n inteligente de paÃ­s por prefijo
    let country = "DESCONOCIDO";
    if(PREFIX_DB[val.substring(0,3)]) country = PREFIX_DB[val.substring(0,3)];
    else if(PREFIX_DB[val.substring(0,2)]) country = PREFIX_DB[val.substring(0,2)];
    else if(PREFIX_DB[val.substring(0,1)]) country = PREFIX_DB[val.substring(0,1)];
    
    document.getElementById('myCountry').value = country;
    render();
}

document.getElementById('bgLoader').onchange = (e) => {
    const r = new FileReader();
    r.onload = (ev) => { bg.src = ev.target.result; bg.onload = render; };
    r.readAsDataURL(e.target.files[0]);
};

function resetBg() { bg = new Image(); render(); }

document.getElementById('adifLoader').onchange = (e) => {
    const r = new FileReader();
    r.onload = (ev) => parseADIF(ev.target.result);
    r.readAsText(e.target.files[0]);
};

function parseADIF(txt) {
    log = txt.split(/<eor>/i).map(chunk => {
        if(chunk.length < 10) return null;
        const extract = (tag) => {
            const m = chunk.match(new RegExp(`<${tag}:\\d+>([^<]*)`, "i"));
            return m ? m[1].trim() : "";
        };
        return { call: extract('CALL'), date: extract('QSO_DATE'), time: extract('TIME_ON'), band: extract('BAND'), mode: extract('MODE'), rst: extract('RST_SENT') };
    }).filter(x => x && x.call);
    if(log.length) { idx = 0; document.getElementById('zipBtn').style.display = 'block'; sync(); }
}

function move(d) { if(log.length) { idx = (idx + d + log.length) % log.length; sync(); } }

function sync() {
    const q = log[idx];
    document.getElementById('tCall').value = q.call;
    document.getElementById('tBand').value = q.band;
    document.getElementById('tMode').value = q.mode;
    document.getElementById('tRst').value = q.rst;
    document.getElementById('tDate').value = q.date.replace(/(\d{4})(\d{2})(\d{2})/, '$3/$2/$1');
    document.getElementById('tTime').value = q.time.substring(0,2)+":"+q.time.substring(2,4);
    document.getElementById('qso-indicator').innerText = `REGISTRO: ${idx+1} / ${log.length}`;
    render();
}

function render() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,1800,1100);
    if(bg.src) ctx.drawImage(bg, 0, 0, 1800, 1100);
    
    ctx.save();
    ctx.shadowBlur = 20; ctx.shadowColor = "black";
    ctx.fillStyle = document.getElementById('c1').value;
    ctx.font = "900 240px sans-serif";
    ctx.fillText(document.getElementById('myCall').value || "CL7ADV", 80, 260);
    
    ctx.fillStyle = document.getElementById('c2').value;
    ctx.font = "bold 90px sans-serif";
    ctx.fillText(document.getElementById('myCountry').value || "CUBA", 95, 380);
    ctx.restore();

    ctx.fillStyle = document.getElementById('c3').value;
    ctx.globalAlpha = 0.9;
    ctx.beginPath(); ctx.roundRect(80, 800, 1640, 210, 25); ctx.fill();
    ctx.globalAlpha = 1.0;
    ctx.strokeStyle = document.getElementById('c4').value;
    ctx.lineWidth = 8; ctx.stroke();

    const data = [document.getElementById('tCall').value, document.getElementById('tDate').value, document.getElementById('tTime').value, document.getElementById('tBand').value, document.getElementById('tMode').value, document.getElementById('tRst').value];
    const labels = ["CORRESPONSAL", "FECHA UTC", "HORA", "BANDA", "MODO", "RST"];
    
    labels.forEach((txt, i) => {
        let x = 130 + (i * 265);
        ctx.fillStyle = document.getElementById('c6').value; ctx.font = "800 22px sans-serif"; ctx.fillText(txt, x, 860);
        ctx.fillStyle = document.getElementById('c5').value; ctx.font = "bold 55px monospace"; ctx.fillText(data[i] || "---", x, 940);
    });
}

function download() {
    const link = document.createElement('a');
    link.download = `QSL_${document.getElementById('tCall').value || 'STATION'}.jpg`;
    link.href = canvas.toDataURL('image/jpeg', 0.9);
    link.click();
}

async function makeZip() {
    const z = new JSZip();
    for(let i=0; i<log.length; i++) {
        idx = i; sync();
        const img = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
        z.file(`${log[i].call}.jpg`, img, {base64: true});
    }
    saveAs(await z.generateAsync({type:"blob"}), "LOG_CL7ADV.zip");
}
</script>
</body>
</html>
