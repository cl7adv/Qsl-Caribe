<script>
  const form = document.getElementById('qsoForm');
  const canvas = document.getElementById('qslCanvas');
  const ctx = canvas.getContext('2d');
  const fondoInput = document.getElementById('fondo'); // campo para subir imagen

  // Tipografías del sistema para robustez
  const fontTitle = "700 62px system-ui, Segoe UI, Arial";
  const fontLabel = "700 20px system-ui, Segoe UI, Arial";
  const fontText  = "400 22px system-ui, Segoe UI, Arial";
  const fontSmall = "400 16px system-ui, Segoe UI, Arial";

  // Botones
  document.getElementById('btnGenerar').addEventListener('click', () => drawCard(readData()));
  document.getElementById('btnDescargar').addEventListener('click', downloadPNG);
  document.getElementById('btnImprimir').addEventListener('click', () => window.print());
  document.getElementById('btnLimpiar').addEventListener('click', () => { form.reset(); drawCard(defaultData()); });

  // Inicial
  drawCard(defaultData());

  function defaultData() {
    return {
      indicativo: "CM2ABC",
      nombre: "Alfred",
      ubicacion: "Santa Cruz del Sur, Camagüey",
      pais: "Cuba",
      fecha: new Date().toISOString().slice(0,10),
      hora: new Date().toISOString().slice(11,16),
      frecuencia: "14.070",
      modo: "SSB",
      rst: "59",
      qsl: "eQSL / LoTW",
      notas: "Gracias por el QSO. 73 y DX!"
    };
  }

  function readData() {
    const get = id => document.getElementById(id).value.trim();
    return {
      indicativo: get("indicativo") || "—",
      nombre: get("nombre"),
      ubicacion: get("ubicacion"),
      pais: get("pais"),
      fecha: get("fecha"),
      hora: get("hora"),
      frecuencia: get("frecuencia"),
      modo: get("modo"),
      rst: get("rst"),
      qsl: get("qsl"),
      notas: get("notas"),
    };
  }

  function downloadPNG() {
    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = `QSL_${Date.now()}.png`;
    a.click();
  }

  function drawCard(d) {
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    // Si hay imagen de fondo seleccionada
    if (fondoInput && fondoInput.files && fondoInput.files[0]) {
      const img = new Image();
      img.onload = () => {
        ctx.drawImage(img, 0, 0, W, H);
        drawOverlay(d); // dibuja encima los datos QSL
      };
      img.src = URL.createObjectURL(fondoInput.files[0]);
    } else {
      // Fondo por defecto si no hay imagen
      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0, "#062036");
      g.addColorStop(1, "#103251");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,W,H);
      drawOverlay(d);
    }
  }

  function drawOverlay(d) {
    const W = canvas.width, H = canvas.height;

    // Tarjeta con borde y sombra
    const pad = 40;
    const card = { x: pad, y: pad, w: W - pad*2, h: H - pad*2, r: 26 };
    roundedRect(card.x, card.y, card.w, card.h, card.r, "#0b1f33", true);
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.lineWidth = 2;
    roundedRect(card.x, card.y, card.w, card.h, card.r, null, false);

    // Franja superior
    const topH = 140;
    ctx.fillStyle = "rgba(63,208,201,0.35)";
    roundedRect(card.x, card.y, card.w, topH, card.r, true);

    // Indicativo grande
    ctx.fillStyle = "#06121f";
    ctx.textBaseline = "top";
    ctx.font = fontTitle;
    const title = (d.indicativo || "—").toUpperCase();
    ctx.fillText(title, card.x + 30, card.y + 30);

    // Datos QSO
    const baseY = card.y + topH + 60;
    const colX1 = card.x + 36;
    const colX2 = card.x + card.w/2 + 20;
    const lineGap = 52;

    drawField("Fecha", d.fecha || "—", colX1, baseY + lineGap*0);
    drawField("Hora (UTC)", d.hora || "—", colX1, baseY + lineGap*1);
    drawField("Frecuencia (MHz)", d.frecuencia || "—", colX1, baseY + lineGap*2);
    drawField("Modo", d.modo || "—", colX1, baseY + lineGap*3);

    drawField("Señal (RST)", d.rst || "—", colX2, baseY + lineGap*0);
    drawField("QSL vía", d.qsl || "—", colX2, baseY + lineGap*1);
    drawField("Operador", d.nombre || "—", colX2, baseY + lineGap*2);
    drawField("QTH", d.ubicacion || "—", colX2, baseY + lineGap*3);

    // Notas
    ctx.font = fontLabel;
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.fillText("Notas", colX1, baseY + lineGap*4 + 30);
    ctx.font = fontText;
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    wrapText(d.notas || "—", colX1, baseY + lineGap*4 + 60, card.w - 72, 28);
  }

  function drawField(label, value, x, y) {
    ctx.textBaseline = "top";
    ctx.font = fontLabel;
    ctx.fillStyle = "rgba(255,255,255,0.7)";
    ctx.fillText(label.toUpperCase(), x, y);
    ctx.font = "400 26px system-ui, Segoe UI, Arial";
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.fillText(value, x, y + 26);
  }

  function roundedRect(x,y,w,h,r,fill=true) {
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    if (fill) ctx.fill(); else ctx.stroke();
  }

  function wrapText(str, x, y, maxW, lineH) {
    if (!str) return;
    const words = str.split(/\s+/);
    let line = "";
    for (let i=0;i<words.length;i++) {
      const test = line + words[i] + " ";
      const w = ctx.measureText(test).width;
      if (w > maxW && i>0) {
        ctx.fillText(line, x, y);
        line = words[i] + " ";
        y += lineH;
      } else {
        line = test;
      }
    }
    ctx.fillText(line, x, y);
  }
</script>
